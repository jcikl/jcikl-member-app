# JCI KL Membership Management System - AI Coding Rules

## ğŸ¯ Project Identity

You are working on the **JCI KL Membership Management System** (è¶…çº§å›½é™…é’å¹´å•†ä¼šå‰éš†å¡åˆ†ä¼šä¼šå‘˜ç®¡ç†ç³»ç»Ÿ) - an enterprise-grade, production-ready web application with 30,000+ lines of code, 200+ components, and 52 Firestore collections.

**Complexity Level**: â­â­â­â­â­ (5/5 - Highly Complex)

---

## ğŸ—ï¸ Architecture Overview

### Tech Stack
- **Frontend**: React 18 + TypeScript 5.2 + Vite 5.0 + Ant Design 5.12
- **State Management**: Zustand (primary), React Context (local)
- **Backend**: Firebase (BaaS) - Firestore + Auth + Storage
- **Image CDN**: Cloudinary (primary)
- **Forms**: React Hook Form + Yup
- **Date/Time**: Day.js
- **Utilities**: Axios, crypto-js, XLSX, pdfjs-dist

### Module Structure (8 Core Modules)
```
src/modules/
â”œâ”€â”€ member/      # ä¼šå‘˜ç®¡ç†
â”œâ”€â”€ finance/     # è´¢åŠ¡ç³»ç»Ÿ
â”œâ”€â”€ event/       # æ´»åŠ¨ç®¡ç†
â”œâ”€â”€ permission/  # æƒé™ç³»ç»Ÿ (RBAC)
â”œâ”€â”€ survey/      # é—®å·ç³»ç»Ÿ
â”œâ”€â”€ award/       # å¥–é¡¹ç³»ç»Ÿ
â”œâ”€â”€ image/       # å›¾ç‰‡ç®¡ç†
â””â”€â”€ system/      # ç³»ç»Ÿè®¾ç½®
```

### 3-Tier Architecture
```
UI Layer (React Components)
    â†“
Business Logic Layer (Services)
    â†“
Data Access Layer (Firestore)
```

---

## ğŸš¨ CRITICAL RULES (Must Follow)

### 1. â›” NEVER Use Hardcoded Values
```typescript
// âŒ FORBIDDEN
const membersRef = collection(db, 'members');
const email = /^[a-z]+@[a-z]+\.[a-z]+$/;

// âœ… REQUIRED
import { GLOBAL_COLLECTIONS } from '@/config/globalCollections';
import { globalValidationService } from '@/config/globalValidationSettings';

const membersRef = collection(db, GLOBAL_COLLECTIONS.MEMBERS);
const emailRegex = GLOBAL_VALIDATION_CONFIG.VALIDATION_RULES.email;
```

### 2. â›” NEVER Pass undefined to Firebase
```typescript
// âŒ WRONG - Will throw error
await setDoc(doc(db, 'members', id), {
  name: data.name,
  phone: data.phone,  // Could be undefined
  avatar: data.avatar // Could be undefined
});

// âœ… CORRECT - Clean undefined values
import { cleanUndefinedValues } from '@/utils/dataHelpers';

await setDoc(doc(db, 'members', id), 
  cleanUndefinedValues({
    name: data.name,
    phone: data.phone ?? null,
    avatar: data.avatar ?? null
  })
);

// âœ… BETTER - Conditional spread
await setDoc(doc(db, 'members', id), {
  name: data.name,
  ...(data.phone && { phone: data.phone }),
  ...(data.avatar && { avatar: data.avatar })
});
```

### 3. âœ… ALWAYS Check Permissions
```typescript
// âŒ WRONG - No permission check
const handleDelete = async () => {
  await memberService.deleteMember(id);
};

// âœ… CORRECT - Check permission first
import { globalPermissionService } from '@/config/globalPermissions';

const handleDelete = async () => {
  const result = await globalPermissionService.checkPermission(
    currentUserId,
    'MEMBER_MANAGEMENT',
    'DELETE'
  );
  
  if (!result.hasPermission) {
    message.error('æƒé™ä¸è¶³');
    return;
  }
  
  await memberService.deleteMember(id);
};
```

### 4. âœ… ALWAYS Use Global Configuration Services
```typescript
// âŒ WRONG - Inline configuration
<Table 
  pagination={{ pageSize: 20 }}
  bordered={false}
  size="middle"
/>

// âœ… CORRECT - Use global config
import { globalComponentService } from '@/config/globalComponentSettings';

const tableConfig = globalComponentService.getTableConfig();
<Table {...tableConfig} />
```

### 5. âœ… ALWAYS Use Global Validation
```typescript
// âŒ WRONG - Custom regex
const emailRegex = /^[a-z0-9]+@[a-z0-9]+\.[a-z]+$/;

// âœ… CORRECT - Global validation
import { globalValidationService } from '@/config/globalValidationSettings';

const isValid = globalValidationService.validateEmail(email);
```

---

## ğŸ“‹ Code Style Guidelines

### TypeScript Standards
```typescript
// âœ… REQUIRED: Explicit types, no 'any'
interface User {
  id: string;
  name: string;
}

const getUser = async (id: string): Promise<User> => {
  // Implementation
};

// âŒ FORBIDDEN
const getUser = async (id: any): Promise<any> => {};
```

### Import Order (STRICT)
```typescript
// 1. React & Third-party
import React, { useState, useEffect } from 'react';
import { Button, Form, Table } from 'antd';

// 2. Global Config (PRIORITY - ALWAYS FIRST)
import { GLOBAL_COLLECTIONS } from '@/config/globalCollections';
import { GLOBAL_SYSTEM_CONFIG, globalSystemService } from '@/config/globalSystemSettings';
import { GLOBAL_COMPONENT_CONFIG, globalComponentService } from '@/config/globalComponentSettings';
import { GLOBAL_VALIDATION_CONFIG, globalValidationService } from '@/config/globalValidationSettings';
import { GLOBAL_DATE_CONFIG, globalDateService } from '@/config/globalDateSettings';
import { GLOBAL_PERMISSION_CONFIG, globalPermissionService } from '@/config/globalPermissions';

// 3. Types
import { Member, Transaction } from '@/types';

// 4. Services
import { memberService } from '@/modules/member/services/memberService';

// 5. Components
import { LoadingSpinner } from '@/components/LoadingSpinner';

// 6. Styles
import './styles.css';
```

### Naming Conventions
```typescript
// Components: PascalCase
MemberListPage, TransactionManagement

// Services: camelCase
memberService, financeService

// Hooks: use prefix
usePermissions, useMemberCategory

// Constants: UPPER_SNAKE_CASE
GLOBAL_COLLECTIONS, MAX_FILE_SIZE

// Types/Interfaces: PascalCase
Member, Transaction, BankAccount
```

### Component Pattern
```typescript
// âœ… REQUIRED: Functional components with TypeScript
interface Props {
  memberId: string;
  onSuccess?: () => void;
}

export const MemberProfile: React.FC<Props> = ({ memberId, onSuccess }) => {
  // Component logic
};

// âœ… Named exports (NOT default)
export { MemberProfile };
```

---

## ğŸ” Security & Data Safety

### Authentication Check
```typescript
// âœ… ALWAYS verify auth state
const { user } = useAuthStore();
if (!user) return <Navigate to="/login" />;
```

### Input Validation (Both Client & Server)
```typescript
// âœ… Use global validation service
const schema = globalValidationService.createSchema({
  email: 'email',
  phone: 'phone',
  password: 'password'
});
```

### XSS Prevention
```typescript
// âœ… Use Ant Design components (auto-escaped)
<Typography.Text>{userInput}</Typography.Text>

// âŒ NEVER use dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userInput }} />
```

---

## ğŸ“Š Critical Business Rules

### 1. Member Fee Standards
| Category | New Fee | Renewal | Tasks Required |
|----------|---------|---------|----------------|
| Official Member | RM 480 | RM 350 | 3 events + 1 course + 1 role |
| Probation Member | RM 250 | RM 200 | 2 events |
| Honorary Member | RM 0 | RM 0 | None |
| Visiting Member | RM 100 | RM 100 | None |

### 2. Event Pricing (4-Tier)
- `regularPrice` - Guest (highest)
- `memberPrice` - JCI members (~30% off)
- `alumniPrice` - Alumni (~20% off)
- `earlyBirdPrice` - Limited time
- Committee members: **FREE**

### 3. Fiscal Year
- Start: October 1
- End: September 30 (next year)
- Example: FY 2024 = 2024-10-01 to 2025-09-30

### 4. Transaction Number Format
`TXN-{YYYY}-{ACCT_LAST_4}-{SEQ_4}`
- Example: `TXN-2024-1234-0001`

---

## ğŸ—„ï¸ Data Models Reference

### Key Collections (52 total)
```typescript
// Member Domain
GLOBAL_COLLECTIONS.MEMBERS
GLOBAL_COLLECTIONS.MEMBER_POSITIONS
GLOBAL_COLLECTIONS.MEMBER_CATEGORIES
GLOBAL_COLLECTIONS.MEMBER_RECRUITMENT

// Finance Domain
GLOBAL_COLLECTIONS.TRANSACTIONS
GLOBAL_COLLECTIONS.BANK_ACCOUNTS
GLOBAL_COLLECTIONS.TRANSACTION_PURPOSES
GLOBAL_COLLECTIONS.BILL_PAYMENTS
GLOBAL_COLLECTIONS.BUDGETS

// Event Domain
GLOBAL_COLLECTIONS.EVENTS
GLOBAL_COLLECTIONS.EVENT_REGISTRATIONS
GLOBAL_COLLECTIONS.EVENT_PARTICIPANTS

// Permission Domain (RBAC)
GLOBAL_COLLECTIONS.RBAC_PERMISSIONS
GLOBAL_COLLECTIONS.RBAC_ROLES
GLOBAL_COLLECTIONS.RBAC_ROLE_BINDINGS

// System Domain
GLOBAL_COLLECTIONS.GLOBAL_SETTINGS
GLOBAL_COLLECTIONS.AUDIT_LOGS
GLOBAL_COLLECTIONS.USER_OPERATION_LOGS
GLOBAL_COLLECTIONS.ONLINE_USERS
GLOBAL_COLLECTIONS.PAGE_VIEWS
```

### Data Transformation Helpers
```typescript
// Firestore Timestamp â†’ ISO String
import { safeTimestampToISO } from '@/utils/dateHelpers';

// undefined â†’ null (MANDATORY)
import { cleanUndefinedValues } from '@/utils/dataHelpers';
```

---

## ğŸ¨ UI/UX Standards

### Use Global Component Config
```typescript
// Table
const tableConfig = globalComponentService.getTableConfig({
  pageSize: 20,  // Override if needed
});

// Form
const formConfig = globalComponentService.getFormConfig({
  layout: 'vertical'
});

// Modal
const modalConfig = globalComponentService.getModalConfig({
  width: 800,
  centered: true
});
```

### Status Colors (CSS Classes)
```css
.status-active      /* Green - Active, Published */
.status-inactive    /* Orange - Inactive, Suspended */
.status-pending     /* Blue - Pending, In Progress */
.status-suspended   /* Red - Disabled, Cancelled, Error */
```

### Date Formats
```typescript
import { globalDateService } from '@/config/globalDateSettings';

// Display format
globalDateService.formatDate(date, 'display'); // DD-MMM-YYYY

// API format
globalDateService.formatDate(date, 'api'); // YYYY-MM-DD

// Filename format
globalDateService.formatDate(date, 'filename'); // YYYYMMDD
```

---

## ğŸ”„ Common Patterns

### Standard CRUD Flow
```typescript
// 1. Service Layer
export const getMembers = async (params: QueryParams) => {
  const q = query(
    collection(db, GLOBAL_COLLECTIONS.MEMBERS),
    where('status', '==', params.status),
    orderBy('createdAt', 'desc'),
    limit(params.limit)
  );
  
  const snapshot = await getDocs(q);
  
  return {
    data: snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    })),
    total: snapshot.size,
    page: params.page,
    limit: params.limit
  };
};

// 2. Component
const [data, setData] = useState([]);

useEffect(() => {
  const fetchData = async () => {
    const result = await memberService.getMembers({ page: 1, limit: 20 });
    setData(result.data);
  };
  fetchData();
}, []);
```

### Permission-Protected Operation
```typescript
const { hasPermission } = usePermission(
  userId, 
  'MEMBER_MANAGEMENT', 
  'DELETE'
);

if (!hasPermission) {
  return <Button disabled>åˆ é™¤</Button>;
}

return <Button onClick={handleDelete}>åˆ é™¤</Button>;
```

---

## ğŸ“ Development Checklist

### Before Writing Code
- [ ] Check if global config exists for this feature
- [ ] Review similar existing implementations
- [ ] Identify all affected consumers
- [ ] Plan permission checks needed

### While Writing Code
- [ ] Use `GLOBAL_COLLECTIONS.*` for all Firestore refs
- [ ] Use global services (validation, date, component)
- [ ] Clean undefined values before Firebase writes
- [ ] Add explicit TypeScript types
- [ ] Implement permission checks
- [ ] Follow import order strictly

### Before Committing
- [ ] Run compliance check (target â‰¥90/100)
- [ ] Run TypeScript check: `npm run type-check`
- [ ] Test primary user flow
- [ ] Update all affected consumers
- [ ] No console.log in production code
- [ ] No hardcoded values

---

## ğŸš¨ Emergency Procedures

### Firestore Rules Expiry (2025-10-10)
```bash
# URGENT: Update production rules
firebase deploy --only firestore:rules
```

### Production Rollback
```bash
git revert [commit]
# Then redeploy
```

### Data Corruption
1. Stop writes (disable features)
2. Export data: `firebase firestore:export`
3. Analyze transaction logs
4. Restore from backup
5. Run integrity checks

---

## ğŸ¯ Performance Targets

- First Contentful Paint: < 1.5s
- Time to Interactive: < 3s
- List rendering (1000 items): < 200ms
- Form submission: < 500ms
- Initial bundle: < 500KB (gzipped)

---

## ğŸ“š Key File Locations

### Global Configuration
```
src/config/
â”œâ”€â”€ globalCollections.ts       # Collection IDs
â”œâ”€â”€ globalPermissions.ts        # RBAC
â”œâ”€â”€ globalSystemSettings.ts     # System config
â”œâ”€â”€ globalComponentSettings.ts  # UI defaults
â”œâ”€â”€ globalValidationSettings.ts # Validation
â”œâ”€â”€ globalDateSettings.ts       # Date formats
â”œâ”€â”€ globalSettingsCommander.ts  # Compliance checker
â””â”€â”€ index.ts                    # Unified exports
```

### Module Structure
```
src/modules/{module_name}/
â”œâ”€â”€ components/    # UI components
â”œâ”€â”€ pages/        # Route pages
â”œâ”€â”€ services/     # Business logic
â”œâ”€â”€ hooks/        # Custom hooks
â”œâ”€â”€ types/        # TypeScript types
â””â”€â”€ __tests__/    # Unit tests
```

---

## ğŸ” Common Issues & Solutions

### Issue: Undefined to Firebase
**Solution**: Always use `cleanUndefinedValues()` or conditional spread

### Issue: Hardcoded collection names
**Solution**: Import and use `GLOBAL_COLLECTIONS.*`

### Issue: Missing permission checks
**Solution**: Use `globalPermissionService.checkPermission()` or `usePermission()` hook

### Issue: Large service files (>500 lines)
**Solution**: Split into focused services (transaction, budget, report)

### Issue: Timestamp conversion errors
**Solution**: Use `Timestamp.fromDate()` for writes, `safeTimestampToISO()` for reads

---

## ğŸ“ Module-Specific Notes

### Finance Module
- Transaction numbers must follow format: `TXN-YYYY-XXXX-NNNN`
- All amounts must be â‰¥ 0
- Budget â†’ Transaction mapping uses keywords
- Fiscal year: Oct 1 - Sep 30

#### ğŸ’° Running Balance Calculation (ç´¯è®¡ä½™é¢è®¡ç®—)
**Critical Logic - Must Follow Exactly**

```typescript
// æ ¸å¿ƒåŸåˆ™ï¼šå®Œå…¨åŸºäºUIåˆ—è¡¨ç‰©ç†é¡ºåºï¼Œä¸ä¾èµ–ä»»ä½•å›ºå®šå­—æ®µ
// è®¡ç®—æ–¹å‘ï¼šä»ä¸‹åˆ°ä¸Š(æ•°ç»„æœ«å°¾â†’å¼€å¤´)ã€ä»åå¾€å‰(æœ€æ—§é¡µâ†’æœ€æ–°é¡µ)

// Step 1: å®šä½å½“å‰é¡µåœ¨å…¨å±€çš„ä½ç½®
const lastTxnOnPage = currentPageTransactions[currentPageTransactions.length - 1];
const globalEndIndex = allTransactions.findIndex(t => t.id === lastTxnOnPage.id);

// Step 2: è®¡ç®—èµ·å§‹ä½™é¢(ç´¯åŠ å½“å‰é¡µä¹‹åçš„æ‰€æœ‰äº¤æ˜“)
let startingBalance = initialBalance;
for (let i = allTransactions.length - 1; i > globalEndIndex; i--) {
  const netAmount = tx.transactionType === 'income' ? tx.amount : -tx.amount;
  startingBalance += netAmount;
}

// Step 3: è®¡ç®—å½“å‰é¡µä½™é¢(ä»ä¸‹åˆ°ä¸Š)
let runningBalance = startingBalance;
for (let i = currentPageTransactions.length - 1; i >= 0; i--) {
  const netAmount = txn.transactionType === 'income' ? txn.amount : -txn.amount;
  runningBalance += netAmount;
  balanceMap.set(txn.id, runningBalance);
}
```

**å…³é”®è¦ç‚¹ï¼š**
- âŒ ä¸ä½¿ç”¨positionå­—æ®µæˆ–ä»»ä½•å›ºå®šæ’åºå­—æ®µ
- âœ… åªä¾èµ–å½“å‰UIåˆ—è¡¨çš„ç‰©ç†é¡ºåº
- âœ… UIåº•éƒ¨(æ•°ç»„æœ«å°¾)= ç¬¬ä¸€ç¬”äº¤æ˜“(æœ€æ—§)
- âœ… UIé¡¶éƒ¨(æ•°ç»„å¼€å¤´)= æœ€æ–°äº¤æ˜“
- âœ… èµ·å§‹ä½™é¢ = åˆå§‹ä½™é¢ + å½“å‰é¡µä¹‹åçš„æ‰€æœ‰äº¤æ˜“
- âœ… åªè®¡ç®—çˆ¶äº¤æ˜“ä½™é¢(è·³è¿‡isVirtualå’Œå­äº¤æ˜“)
- âœ… æ”¯æŒä»»æ„æ’åºè§„åˆ™å˜æ›´åè‡ªåŠ¨é‡æ–°è®¡ç®—

### Member Module
- Category changes require task completion validation
- Permissions auto-sync on category/position change
- Recruitment tracking links introducer to new member

### Event Module
- Multi-tier pricing based on member category
- Registration â†’ Transaction auto-creation on approval
- Level restrictions: Local < Area < National < JCI

### Permission Module
- 4-layer model: User â†’ RoleBinding â†’ Role â†’ Permission
- Scoped permissions support (site-level, event-level)
- Dynamic permission matrix

---

## ğŸŒŸ Best Practices

### DO âœ…
- Import global configs at top of every file
- Use TypeScript strict mode
- Clean undefined before Firebase writes
- Check permissions before operations
- Use named exports
- Follow module structure
- Write unit tests for services
- Handle errors gracefully
- Log operations for audit trail

### DON'T âŒ
- Hardcode collection names
- Use 'any' type
- Skip permission checks
- Pass undefined to Firebase
- Use default exports
- Create files outside module structure
- Leave console.log in production
- Ignore TypeScript errors
- Create helper scripts to bypass standards

---

## ğŸ¯ Code Quality Standards

### Minimum Requirements
- TypeScript strict mode: âœ… Enabled
- Linter errors: 0
- Type errors: 0
- Compliance score: â‰¥ 90/100
- Test coverage: Target 60%
- Bundle size: < 500KB (gzipped)

### Commands
```bash
npm run type-check    # TypeScript validation
npm run lint          # ESLint check
npm run build         # Production build
npm test              # Run tests
```

---

## ğŸ“– Documentation References

- Main technical doc: `.cursor/rules/00-master-enhanced.md`
- API docs: `docs/technical/api/`
- Architecture: `docs/technical/architecture/`
- Troubleshooting: `docs/technical/troubleshooting/`

---

## ğŸš€ Final Reminders

1. **NEVER** hardcode - use `GLOBAL_COLLECTIONS.*` and global services
2. **ALWAYS** convert `undefined` to `null` before Firebase
3. **ALWAYS** check permissions for sensitive operations
4. **ALWAYS** use global validation for forms
5. **ALWAYS** run compliance check before commit (â‰¥90/100)
6. **NEVER** use `any` type - use explicit types
7. **ALWAYS** follow import order (global configs first)
8. **ALWAYS** clean up after refactoring (update all consumers)

---

**Remember**: This is a production system serving real users. Code quality, security, and reliability are paramount. When in doubt, refer to global configs and existing patterns.

**Version**: 2.0
**Last Updated**: 2025-01-13
**Codebase Size**: 30,000+ LOC, 200+ components, 52 collections


