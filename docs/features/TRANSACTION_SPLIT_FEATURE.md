# 🔀 交易拆分功能完整指南

## 功能概述

交易拆分功能允许将一笔交易拆分为多笔子交易，用于明细化资金去向。子交易仅作参考用途，**不影响银行账户余额**。

---

## 🎯 核心特性

### 1. **参考型父子交易模型**
- **父交易（主交易）**：保持不变，继续影响银行余额
- **子交易（拆分项）**：仅作参考/明细，标记为虚拟交易
- **目的**：将一笔交易的金额明细化，便于追踪资金去向

### 2. **自动未分配金额**
如果拆分总额 < 原交易金额，系统自动创建"未分配金额"子交易

### 3. **类别管理优化** 🆕
- 拆分时：父交易的类别字段被**清除**（避免混淆）
- 子交易：各自独立设置类别
- 简化类别：仅三个主要类别（会员费、活动财务、日常账户）

---

## 📊 数据结构

### 拆分前
```javascript
// 父交易（未拆分）
{
  id: "TXN-2025-0001",
  amount: 1000,
  transactionType: "income",
  category: "member-fees",  // ✅ 有类别
  isSplit: false,
  isVirtual: false,         // ✅ 影响银行余额
}
```

### 拆分后

#### 父交易（已拆分）
```javascript
{
  id: "TXN-2025-0001",
  amount: 1000,
  transactionType: "income",
  category: undefined,      // 🔑 类别已清除
  
  // 拆分标记
  isSplit: true,
  splitCount: 3,
  allocatedAmount: 800,
  unallocatedAmount: 200,
  isVirtual: false,         // ✅ 继续影响银行余额 (+1000)
}
```

#### 子交易 1
```javascript
{
  id: "TXN-2025-0002",
  amount: 300,
  transactionType: "income",
  mainDescription: "会员费 - 张三",
  category: "member-fees",  // ✅ 独立类别
  
  // 子交易标记
  parentTransactionId: "TXN-2025-0001",
  isVirtual: true,          // ❌ 不影响银行余额
  isSplit: false,
}
```

#### 子交易 2
```javascript
{
  id: "TXN-2025-0003",
  amount: 500,
  transactionType: "income",
  mainDescription: "活动赞助 - 李四",
  category: "event-finance", // ✅ 独立类别
  
  parentTransactionId: "TXN-2025-0001",
  isVirtual: true,
  isSplit: false,
}
```

#### 子交易 3（自动创建）
```javascript
{
  id: "TXN-2025-0004",
  amount: 200,
  transactionType: "income",
  mainDescription: "未分配金额",
  category: "unallocated",   // 🔑 特殊类别
  
  parentTransactionId: "TXN-2025-0001",
  isVirtual: true,
  isSplit: false,
  notes: "系统自动创建 - 拆分后剩余金额"
}
```

---

## 🎨 UI 界面

### 拆分弹窗（简化版）
```
┌──────────────────────────────────────────┐
│      拆分交易  [RM 1000.00]              │
├──────────────────────────────────────────┤
│ ℹ️ 拆分后的子交易仅作参考，不会影响银   │
│    行账户余额。如果拆分金额总和小于原   │
│    交易金额，系统会自动创建未分配金额   │
│    子交易。                              │
│                                          │
│ 原交易信息：                             │
│ ┌────────────────────────────────────┐  │
│ │ 日期：2025-01-01                   │  │
│ │ 描述：银行转账收入                 │  │
│ │ 类型：收入                         │  │
│ │ 金额：RM 1000.00                   │  │
│ └────────────────────────────────────┘  │
│                                          │
│ ───── 拆分明细 ─────                    │
│                                          │
│ 拆分项 1                      [删除]    │
│ ┌────────────────────────────────────┐  │
│ │ 金额 *        类别 *               │  │
│ │ [300] RM      [会员费 ▼]           │  │
│ │                                    │  │
│ │ 备注                               │  │
│ │ [会员费 - 张三______________]      │  │
│ └────────────────────────────────────┘  │
│                                          │
│ 拆分项 2                      [删除]    │
│ ┌────────────────────────────────────┐  │
│ │ 金额 *        类别 *               │  │
│ │ [500] RM      [活动财务 ▼]         │  │
│ │                                    │  │
│ │ 备注                               │  │
│ │ [活动赞助 - 李四______________]    │  │
│ └────────────────────────────────────┘  │
│                                          │
│ [+ 添加拆分项]                          │
│                                          │
│ ─────────────────────────────────────── │
│ 原交易金额:  RM 1000.00                  │
│ 已分配金额:  RM  800.00                  │
│ 未分配金额:  RM  200.00 ⚠️               │
│                                          │
│ ⚠️ 系统将自动创建"未分配金额"子交易      │
│                                          │
│        [取消]          [确认拆分]        │
└──────────────────────────────────────────┘
```

**字段说明**：
- **金额** ✅ 必填 - 该拆分项的金额
- **类别** ✅ 必填 - 选择类别（会员费/活动财务/日常账户）
- **备注** ⚪ 可选 - 额外说明信息

**自动生成描述**：
- 系统根据类别和金额自动生成描述
- 格式：`{类别} - RM {金额}`
- 例如：`会员费 - RM 300.00`

### 类别选项（简化后）
```
┌─────────────────┐
│ 选择类别        │
├─────────────────┤
│ 会员费          │
│ 活动财务        │
│ 日常账户        │
└─────────────────┘
```

---

## 🔧 拆分流程

### Step 1: 点击"拆分"按钮
在交易列表中，普通交易会显示"拆分"按钮。

**可拆分的交易**：
- ✅ 普通交易（未拆分）
- ❌ 已拆分的父交易（需先撤销）
- ❌ 子交易（虚拟交易）

---

### Step 2: 填写拆分明细
在弹窗中添加拆分项：

**必填字段**：
- ✅ **金额**（必须 > 0）
- ✅ **类别**（会员费/活动财务/日常账户）

**可选字段**：
- ⚪ **备注**（额外说明信息）

**自动生成**：
- 📝 **描述**：系统根据类别和金额自动生成
  - 格式：`{类别} - RM {金额}`
  - 例如：`会员费 - RM 300.00`、`活动财务 - RM 500.00`

---

### Step 3: 系统自动处理

#### 验证
```typescript
✅ 拆分总额 <= 原交易金额
✅ 每个拆分项金额 > 0
✅ 每个拆分项有描述
```

#### 创建子交易
```typescript
// 用户定义的拆分项（自动生成描述）
子交易1: { 
  amount: 300, 
  category: "member-fees",
  mainDescription: "会员费 - RM 300.00",  // 🔑 自动生成
  notes: "会员费 - 张三"
}

子交易2: { 
  amount: 500, 
  category: "event-finance",
  mainDescription: "活动财务 - RM 500.00",  // 🔑 自动生成
  notes: "活动赞助 - 李四"
}

// 自动创建未分配金额（如有）
子交易3: { 
  amount: 200, 
  category: "unallocated",
  mainDescription: "未分配金额",
  notes: "系统自动创建 - 拆分后剩余金额"
}
```

#### 更新父交易
```typescript
父交易更新:
  isSplit: true
  splitCount: 3
  allocatedAmount: 800
  unallocatedAmount: 200
  category: undefined  // 🔑 清除类别
```

---

### Step 4: 显示结果
```
父交易：银行转账收入 [已拆分 3]     +RM 1000.00  RM 50000
  └─ 会员费 - RM 300.00 [子项]      RM 300.00    -
  └─ 活动财务 - RM 500.00 [子项]    RM 500.00    -
  └─ 未分配金额 [子项] [未分配]      RM 200.00    -
```

**说明**：
- 子交易描述自动生成为：`{类别} - RM {金额}`
- 备注信息不显示在列表中，但可在详情中查看

---

## 🔄 撤销拆分流程

### Step 1: 点击"撤销"按钮
已拆分的父交易会显示"撤销"按钮。

---

### Step 2: 确认撤销
```
┌────────────────────────────────┐
│      确认撤销拆分              │
├────────────────────────────────┤
│ 撤销后将删除所有子交易，恢复  │
│ 原交易状态。此操作无法撤销。  │
│                                │
│ ⚠️ 注意：类别需手动重新设置    │
│                                │
│    [取消]      [确认撤销]      │
└────────────────────────────────┘
```

---

### Step 3: 系统自动处理
```typescript
1. 查找所有子交易
2. 删除所有子交易
3. 恢复父交易状态:
   - isSplit: false
   - splitCount: null
   - allocatedAmount: null
   - unallocatedAmount: null
   - category: undefined  // 🔑 不恢复，需手动设置
```

---

### Step 4: 显示结果
```
父交易：银行转账收入  +RM 1000.00  RM 50000  [拆分]
（所有子交易已删除）
```

**⚠️ 注意**：撤销后类别为空，需要手动编辑交易重新设置类别。

---

## 📋 类别管理规则

### 拆分前
```
父交易类别: "member-fees" (会员费)
```

### 拆分后
```
父交易类别: undefined (已清除) 🔑
子交易1类别: "member-fees" (会员费)
子交易2类别: "event-finance" (活动财务)
子交易3类别: "unallocated" (未分配)
```

### 撤销拆分后
```
父交易类别: undefined (需手动重新设置) 🔑
```

---

## 🎯 类别说明

### 三大主要类别

#### 1️⃣ 会员费 (member-fees)
- 会员入会费
- 会员年费
- 会员续费
- 会员升级费

#### 2️⃣ 活动财务 (event-finance)
- 活动收入
- 活动支出
- 赞助收入
- 报名费

#### 3️⃣ 日常账户 (general-accounts)
- 办公用品
- 水电费
- 租金
- 工资
- 其他日常开支

#### 🔸 特殊类别：未分配 (unallocated)
- 系统自动创建
- 表示拆分后的剩余金额
- 可后续编辑并重新分配

---

## 💡 使用场景

### 场景 1：批量会员费收入
```
原交易：
  银行转账收入 +RM 1050 (包含3个会员费)

拆分输入：
  拆分项1: 金额=350, 类别=会员费, 备注=张三
  拆分项2: 金额=350, 类别=会员费, 备注=李四
  拆分项3: 金额=350, 类别=会员费, 备注=王五

拆分后：
  └─ 会员费 - RM 350.00 [子项]    (备注: 张三)
  └─ 会员费 - RM 350.00 [子项]    (备注: 李四)
  └─ 会员费 - RM 350.00 [子项]    (备注: 王五)

结果：
  父交易类别：undefined (清除)
  银行余额：+RM 1050 (仅父交易影响)
  明细追踪：3个独立的会员费记录
```

---

### 场景 2：混合收入拆分
```
原交易：
  银行转账收入 +RM 1500 (会员费 + 活动赞助)

拆分输入：
  拆分项1: 金额=350, 类别=会员费, 备注=张三
  拆分项2: 金额=350, 类别=会员费, 备注=李四
  拆分项3: 金额=500, 类别=活动财务, 备注=ABC公司赞助

拆分后：
  └─ 会员费 - RM 350.00 [子项]      (备注: 张三)
  └─ 会员费 - RM 350.00 [子项]      (备注: 李四)
  └─ 活动财务 - RM 500.00 [子项]    (备注: ABC公司赞助)
  └─ 未分配金额 [子项] [未分配]      RM 300.00

结果：
  父交易类别：undefined (清除)
  子交易类别：各自独立分类
  便于后续统计和报表分析
```

---

### 场景 3：办公采购支出
```
原交易：
  办公用品采购 -RM 5000

拆分输入：
  拆分项1: 金额=2000, 类别=日常账户, 备注=打印机采购
  拆分项2: 金额=2500, 类别=日常账户, 备注=电脑采购

拆分后：
  └─ 日常账户 - RM 2000.00 [子项]   (备注: 打印机采购)
  └─ 日常账户 - RM 2500.00 [子项]   (备注: 电脑采购)
  └─ 未分配金额 [子项] [未分配]      RM 500.00

结果：
  父交易类别：undefined (清除)
  明细化采购项目
```

---

## 🔄 完整操作流程图

```
普通交易 (category: "member-fees")
    │
    ├─ [拆分] 按钮
    │
    ▼
拆分弹窗
    │
    ├─ 添加拆分项 (各自设置类别)
    │   └─ 子交易1: category = "member-fees"
    │   └─ 子交易2: category = "event-finance"
    │
    ├─ 自动计算未分配金额
    │   └─ 子交易3: category = "unallocated"
    │
    ▼
确认拆分
    │
    ├─ 创建所有子交易 (isVirtual = true)
    ├─ 更新父交易:
    │   - isSplit = true
    │   - category = undefined  🔑 清除
    │
    ▼
拆分完成
    │
父交易 (category: undefined) [已拆分 3]
  ├─ 子交易1 (category: "member-fees") [子项]
  ├─ 子交易2 (category: "event-finance") [子项]
  └─ 子交易3 (category: "unallocated") [子项] [未分配]
```

---

## ⚠️ 重要注意事项

### 1. 类别清除规则
```
拆分前：父交易有类别 (如 "member-fees")
拆分后：父交易类别被清除 (undefined)
原因：避免父交易类别与子交易类别混淆
```

### 2. 撤销拆分后
```
撤销后：父交易类别保持为空 (undefined)
需要：手动编辑交易，重新设置类别
```

**为什么不恢复类别？**
- 拆分时类别已被清除，无法恢复
- 子交易可能有多个不同类别，无法确定恢复哪个
- 需要用户根据实际情况重新分类

---

### 3. 余额计算规则
```
银行余额 = ∑(isVirtual !== true 的交易)
         = 只计算父交易，不计算子交易

累计余额 = 同上
```

**示例**：
```
父交易: +1000 → 影响余额 (+1000)
  └─ 子交易1: 300  → 不影响余额 (0)
  └─ 子交易2: 500  → 不影响余额 (0)
  └─ 子交易3: 200  → 不影响余额 (0)

最终余额变化: +1000 (只有父交易)
```

---

### 4. 筛选和搜索
```
类别筛选 = "member-fees"
结果：
  ✅ 子交易（category = "member-fees"）
  ❌ 父交易（category = undefined）
```

**原因**：拆分后父交易类别已清除，只有子交易有类别。

---

## 📊 统计和报表

### 收入/支出统计
```typescript
// 自动排除虚拟交易
totalIncome = ∑(父交易 where transactionType = 'income')
totalExpense = ∑(父交易 where transactionType = 'expense')
```

### 类别统计
```typescript
// 统计子交易的类别分布
会员费: ∑(子交易 where category = 'member-fees')
活动财务: ∑(子交易 where category = 'event-finance')
日常账户: ∑(子交易 where category = 'general-accounts')
```

---

## 🎓 最佳实践

### ✅ 推荐做法

1. **拆分前规划好类别**
   - 明确每个拆分项的类别
   - 避免混用类别

2. **及时处理未分配金额**
   - 定期检查"未分配"类别的子交易
   - 编辑并重新分配到正确类别

3. **谨慎撤销拆分**
   - 撤销后需手动重新设置类别
   - 确保不影响已有的统计数据

4. **使用明确的描述**
   - 每个拆分项描述清晰
   - 便于后续追踪和审计

---

### ❌ 避免做法

1. 不要拆分已拆分的交易（需先撤销）
2. 不要手动删除子交易（使用撤销拆分）
3. 不要忘记处理未分配金额
4. 撤销拆分后不要忘记重新设置类别

---

## 🔍 查询示例

### 查找所有已拆分的交易
```
UI: 查看交易列表，找带有 [已拆分 N] 标签的交易
```

### 查找特定类别的子交易
```
类别筛选: 会员费
结果: 所有类别为"会员费"的子交易
```

### 查找未分配金额
```
类别筛选: 未分配
结果: 所有自动创建的"未分配金额"子交易
```

---

## 🚀 技术实现细节

### 类别清除实现
```typescript
// 使用 Firestore deleteField() 删除字段
import { deleteField } from 'firebase/firestore';

await updateDoc(parentRef, {
  ...otherUpdates,
  category: deleteField(), // 从数据库中删除该字段
});
```

### 类别选项配置
```typescript
// SplitTransactionModal.tsx
<Select>
  <Option value="member-fees">会员费</Option>
  <Option value="event-finance">活动财务</Option>
  <Option value="general-accounts">日常账户</Option>
</Select>
```

---

## 📈 数据流向

```
拆分操作流程:

1. 验证输入
   ↓
2. 创建子交易 (3条)
   - 子交易1: category = "member-fees"
   - 子交易2: category = "event-finance"  
   - 子交易3: category = "unallocated"
   ↓
3. 更新父交易
   - category: deleteField()  🔑 删除类别字段
   - isSplit: true
   ↓
4. 刷新列表
   ↓
5. 父交易显示为"已拆分"，无类别标签
   子交易显示各自类别
```

---

## 🎯 FAQ

### Q1: 为什么拆分后父交易没有类别？
**A**: 为了避免混淆。拆分后，类别信息已在各个子交易中体现，父交易的类别会被清除。

---

### Q2: 撤销拆分后如何恢复类别？
**A**: 需要手动编辑交易，重新选择类别。系统无法自动恢复，因为子交易可能有多个不同类别。

---

### Q3: 未分配金额可以修改吗？
**A**: 可以。未分配金额是普通的子交易，可以编辑描述、类别等信息，将其重新分配到正确的类别。

---

### Q4: 子交易为什么不影响银行余额？
**A**: 子交易标记为虚拟交易 (`isVirtual = true`)，仅作参考。父交易已经影响了银行余额，子交易再影响会导致重复计算。

---

### Q5: 可以只拆分部分金额吗？
**A**: 可以。拆分总额 < 原交易金额时，系统会自动创建"未分配金额"子交易，记录剩余部分。

---

## 📞 相关功能

- 💰 [累计余额显示](./RUNNING_BALANCE_IMPLEMENTATION.md)
- 🔍 [搜索功能指南](./SEARCH_FEATURE_GUIDE.md)
- 📋 [批量操作指南](./BULK_OPERATIONS_GUIDE.md)
- 🏦 多账户标签页

---

**最后更新**: 2025-01-16  
**版本**: 2.0  
**适用范围**: 交易管理页面

