# 📋 子交易显示功能说明

## 功能概述

交易记录管理列表现已支持**子交易显示**，拆分后的子交易会自动显示在父交易下方，形成清晰的层级结构。

---

## 🎨 显示效果

### 列表展示
```
┌─────────────────────────────────────────────────────────────┐
│ □ 日期        描述                金额        累计余额  操作 │
├─────────────────────────────────────────────────────────────┤
│ ☑ 01-Jan  银行转账 [已拆分3]  +1000.00   50000   [撤销]   │
│   ☐ └─ 会员费-RM 300.00[子项]   300.00    -      [查看]   │
│   ☐ └─ 活动财务-RM 500.00[子项] 500.00    -      [查看]   │
│   ☐ └─ 未分配金额[子项][未分配]  200.00    -      [查看]   │
│ ☑ 02-Jan  活动收入            +500.00    50500   [拆分]   │
│ ☑ 03-Jan  办公用品            -200.00    50300   [拆分]   │
└─────────────────────────────────────────────────────────────┘
```

### 层级标识
- **父交易**：
  - 显示 `[已拆分 N]` 标签
  - 有"撤销"按钮
  - 可以选择（复选框可用）
  
- **子交易**：
  - 前缀：`└─` 缩进符号
  - 显示 `[子项]` 标签
  - 如果是未分配金额，额外显示 `[未分配]` 标签
  - 复选框禁用（不可单独选择）
  - 只有"查看"按钮（不可编辑/删除）

---

## 🔧 技术实现

### 1. 智能分组排序
```typescript
// 排序逻辑
1. 按交易日期降序排序（最新在前）
2. 同一日期的交易：
   - 父交易排在前面
   - 子交易紧跟在父交易后面
   - 同一父交易的子交易按创建时间排序
```

### 2. 智能分页
```typescript
// 分页逻辑
- 确保父交易和其所有子交易在同一页
- 如果父交易在页面边界，子交易也会一起显示
- 每页可能显示略多于设定数量（为包含完整组）
```

**示例**：
```
设置: 每页 20 条

页面可能显示：
  - 18 条父交易
  - 6 条子交易（属于页面边界的2个父交易）
  - 总计: 24 条（> 20，但保持组完整性）
```

### 3. 累计余额计算
```typescript
// 只计算父交易（非虚拟交易）
- 父交易: 影响累计余额
- 子交易: 不影响累计余额，显示 "-"
```

---

## 📊 显示规则

### 父交易显示
```
✅ 正常显示
✅ 显示累计余额
✅ 有 [已拆分 N] 标签
✅ 操作：查看、撤销、编辑、删除
✅ 可以选择（多选）
✅ 类别为空（已清除）
```

### 子交易显示
```
✅ 缩进显示（└─ 符号）
✅ 有 [子项] 标签
✅ 未分配金额额外有 [未分配] 标签
✅ 累计余额显示 "-"（不影响余额）
❌ 复选框禁用（不可选择）
❌ 操作：只有"查看"
✅ 有独立的类别
```

---

## 🎯 用户体验

### 清晰的层级关系
```
父交易（主交易）
  └─ 子交易1（明细）
  └─ 子交易2（明细）
  └─ 子交易3（明细）
```

### 视觉区分
- **缩进符号**：`└─` 清晰表示层级
- **颜色区分**：子交易描述为灰色斜体
- **标签标识**：
  - 🟠 `[已拆分 3]` - 父交易
  - 🔵 `[子项]` - 子交易
  - ⚪ `[未分配]` - 未分配金额

### 交互限制
- 子交易复选框禁用（防止误选）
- 子交易不能编辑/删除（通过父交易管理）
- 子交易累计余额显示 `-`（不参与计算）

---

## 💡 操作指南

### 查看拆分明细
```
1. 找到带 [已拆分 N] 标签的交易
2. 子交易会自动显示在下方
3. 查看每个子交易的：
   - 金额
   - 类别
   - 备注（点击查看）
```

### 修改拆分明细
```
方式1: 撤销重新拆分
  1. 点击父交易的"撤销"按钮
  2. 所有子交易被删除
  3. 重新拆分父交易

方式2: 不支持直接编辑子交易
  - 原因：子交易为虚拟交易，仅作参考
  - 需要通过父交易管理
```

### 删除拆分交易
```
删除父交易：
  - 父交易和所有子交易一起删除
  - 银行余额只回退父交易金额
  - 一次性清除完整的拆分组

不能删除单个子交易：
  - 子交易没有删除按钮
  - 需通过撤销拆分统一处理
```

---

## 🔍 筛选和搜索

### 按类别筛选
```
筛选: 会员费
结果:
  ✅ 类别为"会员费"的子交易
  ❌ 已拆分的父交易（类别已清除）
  
显示：
  子交易: 会员费 - RM 300.00 [子项]
  （父交易不显示，因为类别已被清除）
```

### 搜索子交易
```
搜索: "未分配"
结果:
  - 所有"未分配金额"的子交易
  - 带 [未分配] 标签
```

---

## 📊 分页行为

### 智能分组分页
```
原理：
  - 父交易和其子交易视为一个"组"
  - 分页时保持组的完整性
  - 避免父交易在一页，子交易在另一页

示例：
  页面1 (设置20条/页):
    - 交易1 [已拆分3] + 3个子交易 = 4条
    - 交易2 [已拆分2] + 2个子交易 = 3条
    - 交易3-8 (无拆分) = 6条
    - 交易9 [已拆分5] + 5个子交易 = 6条
    - 交易10 [已拆分3] + 3个子交易 = 4条
    总计: 23条 (> 20，但保持组完整)
```

### 总数统计
```
总计: 包含所有交易（父+子）
示例:
  - 50 条父交易
  - 150 条子交易
  - 总计: 200 条
```

---

## ⚠️ 注意事项

### 1. 累计余额
- **父交易**：显示累计余额
- **子交易**：显示 `-`（不影响余额）

### 2. 多选限制
- **父交易**：可以多选
- **子交易**：复选框禁用，不能选择

### 3. 批量操作
- 批量操作只影响父交易
- 子交易自动跳过或随父交易处理

### 4. 删除行为
- 删除父交易 → 子交易一起删除
- 不能单独删除子交易

---

## 🎓 最佳实践

### ✅ 推荐做法
1. **查看明细**：通过子交易查看资金明细分配
2. **类别筛选**：使用类别筛选器快速找到特定类别的子交易
3. **定期整理**：定期检查"未分配"类别，进行重新分配

### ❌ 避免做法
1. 不要尝试单独编辑/删除子交易（不支持）
2. 不要尝试多选子交易（复选框已禁用）
3. 不要对已拆分的父交易设置类别（会造成混淆）

---

## 📈 数据流向

```
拆分前:
  父交易 (RM 1000, category: "member-fees")

拆分后:
  父交易 (RM 1000, category: undefined) [已拆分3]
    └─ 子交易1 (RM 300, category: "member-fees") [子项]
    └─ 子交易2 (RM 500, category: "event-finance") [子项]
    └─ 子交易3 (RM 200, category: "unallocated") [子项][未分配]

列表显示:
  ✅ 4条记录（1父 + 3子）
  ✅ 层级清晰
  ✅ 累计余额: 父交易 RM 51000，子交易 "-"
```

---

## 🔗 相关功能

- 🔀 [交易拆分功能](./TRANSACTION_SPLIT_FEATURE.md)
- 📋 [批量拆分和类别设定](./BATCH_SPLIT_AND_CATEGORY_GUIDE.md)
- 💰 累计余额显示
- 🔍 搜索功能

---

**最后更新**: 2025-01-16  
**版本**: 1.0  
**适用范围**: 交易管理页面

