# 🔀 批量拆分和类别设定功能指南

## 功能概述

批量操作功能现已扩展，支持：
1. **批量拆分** - 为多条交易应用相同的拆分规则（按百分比）
2. **批量设置类别** - 为多条交易统一设置类别

---

## 🎯 功能 1：批量拆分

### 核心概念
**按百分比拆分规则**，应用到所有选中的交易。

**适用场景**：
- 批量处理相同模式的交易
- 快速拆分大量会员费收入
- 统一拆分活动收入

---

### 📊 拆分规则设计

#### 固定金额拆分 🆕
```
拆分规则（固定金额）：
  - RM 300 → 会员费
  - RM 200 → 活动财务
  - 剩余金额 → 自动创建"未分配金额"

应用到交易：
  交易A (RM 1000):
    └─ 会员费 - RM 300.00
    └─ 活动财务 - RM 200.00
    └─ 未分配金额 - RM 500.00
  
  交易B (RM 800):
    └─ 会员费 - RM 300.00
    └─ 活动财务 - RM 200.00
    └─ 未分配金额 - RM 300.00
  
  交易C (RM 450):
    ⚠️ 拆分失败：总金额 RM 500 超过交易金额 RM 450
```

---

### 🎨 批量拆分界面（按固定金额）

```
┌──────────────────────────────────────────────────────────┐
│          批量拆分 - 已选择 5 条交易                      │
├──────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────┐  │
│ │ 拆分总金额: RM 500.00                              │  │
│ │ 💡 将从每条交易中扣除此金额，剩余部分自动创建      │  │
│ │   "未分配金额"子交易                               │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ ───────── 拆分规则（按固定金额） ─────────              │
│                                                          │
│ 规则 1                                        [删除]    │
│ ┌────────────────────────────────────────────────────┐  │
│ │ 金额 *        类别 *                               │  │
│ │ [300] RM      [会员费 ▼]                           │  │
│ │                                                    │  │
│ │ 备注                                               │  │
│ │ [会员费收入______________________]                 │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ 规则 2                                        [删除]    │
│ ┌────────────────────────────────────────────────────┐  │
│ │ 金额 *        类别 *                               │  │
│ │ [200] RM      [活动财务 ▼]                         │  │
│ │                                                    │  │
│ │ 备注                                               │  │
│ │ [活动赞助收入____________________]                 │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ [+ 添加拆分规则]                                        │
│                                                          │
│ ℹ️ 每条交易将按照上述固定金额规则拆分。例如：设置     │
│   RM 300 会员费，每条交易都会拆分出 RM 300 的会员费   │
│   子交易，剩余金额自动创建"未分配金额"子交易。        │
│                                                          │
│                  [取消]      [确认批量拆分]             │
└──────────────────────────────────────────────────────────┘
```

---

### 🔧 批量拆分流程

#### Step 1: 选择交易
```
☑ 交易1: +RM 1000
☑ 交易2: +RM 500
☑ 交易3: +RM 750
☑ 交易4: +RM 1200
☑ 交易5: +RM 800
```

#### Step 2: 点击"批量拆分"按钮
批量操作栏中点击"批量拆分"按钮。

#### Step 3: 设置拆分规则（固定金额）
```
规则1: RM 300 → 会员费
规则2: RM 200 → 活动财务
剩余: 自动创建未分配金额
```

#### Step 4: 确认拆分
系统逐个处理每条交易：
```
处理中...
✅ 交易1 (RM 1000) 拆分成功 (3个子交易: 300+200+500未分配)
✅ 交易2 (RM 800) 拆分成功 (3个子交易: 300+200+300未分配)
✅ 交易3 (RM 1200) 拆分成功 (3个子交易: 300+200+700未分配)
⚠️ 交易4 (RM 450) 拆分失败：总金额 RM 500 超过交易金额
✅ 交易5 (RM 600) 拆分成功 (3个子交易: 300+200+100未分配)

结果: 成功 4 条，失败 1 条
```

#### Step 5: 查看结果
```
交易1 (RM 1000) [已拆分 3]:
  └─ 会员费 - RM 300.00
  └─ 活动财务 - RM 200.00
  └─ 未分配金额 - RM 500.00

交易2 (RM 800) [已拆分 3]:
  └─ 会员费 - RM 300.00
  └─ 活动财务 - RM 200.00
  └─ 未分配金额 - RM 300.00

... (其他交易类似)
```

---

## 🏷️ 功能 2：批量设置类别

### 核心概念
为多条交易统一设置类别。

**适用场景**：
- 批量标记会员费交易
- 统一分类活动财务交易
- 整理未分类的交易

---

### 🎨 批量设置类别界面

```
┌──────────────────────────────────────────┐
│  批量设置类别 - 已选择 10 条交易         │
├──────────────────────────────────────────┤
│ ⚠️ 注意                                  │
│ 此操作将覆盖所有选中交易的类别。虚拟    │
│ 交易（子交易）将被自动跳过。            │
│                                          │
│ 选择类别 *                               │
│ ┌────────────────────────────────────┐  │
│ │ [会员费 ▼]                         │  │
│ └────────────────────────────────────┘  │
│                                          │
│ ┌────────────────────────────────────┐  │
│ │ 将为 10 条交易设置类别为：会员费    │  │
│ └────────────────────────────────────┘  │
│                                          │
│        [取消]          [确认设置]        │
└──────────────────────────────────────────┘
```

---

### 🔧 批量设置类别流程

#### Step 1: 选择交易
```
☑ 交易1 (无类别)
☑ 交易2 (类别: 活动财务)
☑ 交易3 (无类别)
☑ 交易4 (类别: 日常账户)
```

#### Step 2: 点击"设置类别"按钮
批量操作栏中点击"设置类别"按钮。

#### Step 3: 选择类别
```
选择: 会员费
```

#### Step 4: 确认设置
系统逐个处理：
```
处理中...
✅ 交易1 设置成功 → 会员费
✅ 交易2 设置成功 → 会员费 (覆盖原类别)
✅ 交易3 设置成功 → 会员费
✅ 交易4 设置成功 → 会员费 (覆盖原类别)

结果: 成功 4 条
```

#### Step 5: 查看结果
所有选中交易的类别都更新为"会员费"。

---

## 📋 操作规则

### 批量拆分规则

| 规则 | 说明 |
|------|------|
| ✅ 百分比总和 ≤ 100% | 允许部分分配 |
| ✅ 自动创建未分配 | 剩余百分比自动创建子交易 |
| ❌ 已拆分交易跳过 | 已拆分的交易不会重复拆分 |
| ❌ 虚拟交易跳过 | 子交易不能拆分 |
| ✅ 金额自动计算 | 根据百分比自动计算金额 |

### 批量设置类别规则

| 规则 | 说明 |
|------|------|
| ✅ 覆盖现有类别 | 会覆盖交易原有的类别 |
| ❌ 虚拟交易跳过 | 子交易类别不能修改 |
| ✅ 无类别交易 | 可以为无类别的交易设置类别 |

---

## 💡 使用场景

### 场景 1：批量处理会员费收入
```
目标：将 50 条会员费银行转账拆分为明细

步骤：
1. 筛选：搜索 "会员费" 或特定月份
2. 全选当前页（或部分选择）
3. 点击"批量拆分"
4. 设置规则：
   - 100% → 会员费
5. 确认

结果：
  50条交易 × 1个子交易 = 50个会员费明细
```

---

### 场景 2：混合收入批量拆分
```
目标：将混合收入按比例拆分

步骤：
1. 选择 10 条混合收入交易
2. 点击"批量拆分"
3. 设置规则：
   - 40% → 会员费
   - 40% → 活动财务
   - 剩余 20% → 自动创建未分配
4. 确认

结果：
  10条交易 × 3个子交易 = 30个子交易
  - 10个会员费子交易
  - 10个活动财务子交易
  - 10个未分配子交易
```

---

### 场景 3：批量整理未分类交易
```
目标：为所有未分类交易设置类别

步骤：
1. 类别筛选：选择"所有类别"
2. 手动筛选无类别的交易
3. 全选
4. 点击"设置类别"
5. 选择：日常账户
6. 确认

结果：
  所有选中交易的类别更新为"日常账户"
```

---

### 场景 4：活动收入分类
```
目标：将某个活动的所有收入标记为活动财务

步骤：
1. 搜索：活动名称
2. 全选
3. 点击"设置类别"
4. 选择：活动财务
5. 确认

结果：
  所有活动相关交易统一分类为"活动财务"
```

---

## 🎯 界面展示

### 批量操作栏（扩展后）
```
┌──────────────────────────────────────────────────────────────────────┐
│ 已选择 5 项                                                          │
│ [批准] [批量拆分] [设置类别] [导出] [删除]  [全选] [取消选择]        │
└──────────────────────────────────────────────────────────────────────┘
```

**新增按钮**：
- 🔀 **批量拆分** - 按百分比规则拆分多条交易
- 🏷️ **设置类别** - 为多条交易统一设置类别

---

## 🔍 批量拆分 vs 单个拆分

| 特性 | 单个拆分 | 批量拆分 |
|------|---------|---------|
| 拆分方式 | 每笔自定义金额 | 统一固定金额 |
| 适用场景 | 单笔交易明细化 | 批量统一规则 |
| 灵活性 | 高（每项自定义） | 中（统一规则） |
| 效率 | 低（逐个操作） | 高（一次处理） |
| 示例 | 拆分为 300+500+200 | 每笔拆分 300+200 |

---

## ⚡ 效率对比

### 传统方式（单个拆分）
```
50条交易 × 3分钟/条 = 150分钟 (2.5小时)
```

### 批量拆分
```
设置规则(2分钟) + 执行(5分钟) = 7分钟
效率提升: 21x
```

### 批量设置类别
```
100条交易
传统: 逐个编辑 × 30秒/条 = 50分钟
批量: 2分钟
效率提升: 25x
```

---

## 📊 实际案例

### 案例 1：月度会员费收入拆分
```
背景：
  - 银行转账 30 笔，每笔包含多个会员费
  - 平均每笔 RM 1050 (3个会员费 × RM 350)

操作：
1. 筛选月度会员费转账（30条）
2. 全选
3. 批量拆分（固定金额）：
   - 规则1: RM 350 → 会员费 (备注: 第1位会员)
   - 规则2: RM 350 → 会员费 (备注: 第2位会员)
   - 规则3: RM 350 → 会员费 (备注: 第3位会员)
4. 确认

结果：
  每笔 RM 1050 交易拆分为：
    └─ 会员费 - RM 350.00 (第1位)
    └─ 会员费 - RM 350.00 (第2位)
    └─ 会员费 - RM 350.00 (第3位)
    └─ 未分配金额 - RM 0.00 (无剩余)
  
  30条父交易 × 4个子交易 = 120个明细
  处理时间：< 5分钟
```

---

### 案例 2：活动收入整理
```
背景：
  - 某个活动产生 50 条收入交易
  - 未设置类别

操作：
1. 搜索活动名称
2. 全选（50条）
3. 批量设置类别：活动财务
4. 确认

结果：
  50条交易统一标记为"活动财务"
  处理时间：< 1分钟
```

---

### 案例 3：混合收入拆分
```
背景：
  - 赞助商转账 20 笔
  - 每笔包含：赞助费 + 活动报名费

操作：
1. 选择 20 条赞助商转账
2. 批量拆分：
   - 规则1: 70% → 活动财务 (备注: 赞助费)
   - 规则2: 30% → 活动财务 (备注: 报名费)
3. 确认

结果：
  20条父交易 × 2个子交易 = 40个明细
  - 20个赞助费子交易 (70%)
  - 20个报名费子交易 (30%)
```

---

## ⚠️ 重要注意事项

### 批量拆分

1. **百分比精度**
   - 支持1位小数（如 33.3%）
   - 金额自动四舍五入到2位小数

2. **已拆分交易**
   - 已拆分的交易会被自动跳过
   - 不会报错，只会在结果中显示失败数量

3. **虚拟交易**
   - 子交易（虚拟交易）会被自动跳过
   - 复选框已禁用，无法选择

4. **未分配金额**
   - 如果百分比总和 < 100%，自动创建未分配子交易
   - 如果百分比总和 = 100%，不创建未分配子交易

### 批量设置类别

1. **覆盖规则**
   - 会覆盖交易原有的类别
   - 无法撤销，请谨慎操作

2. **虚拟交易保护**
   - 子交易的类别由拆分操作管理
   - 批量设置时自动跳过子交易

3. **已拆分交易**
   - 可以为已拆分的父交易设置类别
   - 但建议保持父交易无类别（避免混淆）

---

## 🎓 最佳实践

### ✅ 推荐做法

#### 批量拆分
1. **先筛选后拆分**
   - 使用筛选器缩小范围
   - 确保选中的交易模式一致

2. **合理设置百分比**
   - 根据实际业务比例设置
   - 可以不分配满 100%（剩余自动创建）

3. **添加清晰备注**
   - 为每个规则添加备注
   - 便于后续识别

#### 批量设置类别
1. **分批处理**
   - 按类别分批设置
   - 避免误设置

2. **使用筛选器**
   - 先筛选出特定模式的交易
   - 再批量设置类别

3. **定期整理**
   - 定期检查无类别交易
   - 批量设置类别

---

### ❌ 避免做法

1. **不验证就批量拆分**
   - 可能拆分不适合的交易
   - 导致大量无意义子交易

2. **覆盖已正确分类的交易**
   - 批量设置类别会覆盖现有类别
   - 操作前请筛选

3. **对已拆分交易设置类别**
   - 已拆分的父交易类别应为空
   - 类别信息在子交易中

---

## 🔄 组合使用

### 完整工作流
```
1. 导入交易数据
   ↓
2. 批量设置类别（初步分类）
   ↓
3. 筛选特定类别
   ↓
4. 批量拆分（明细化）
   ↓
5. 检查未分配金额
   ↓
6. 手动调整特殊情况
   ↓
7. 完成分类和明细化
```

---

## 📈 数据统计

### 批量拆分后
```
原数据：
  - 50条父交易
  - 类别混乱或无类别

批量拆分后：
  - 50条父交易（无类别）
  - 150个子交易（各自有类别）
  
统计优势：
  ✅ 按类别统计：清晰准确
  ✅ 按明细追踪：完整详细
  ✅ 余额计算：不受影响（只计算父交易）
```

---

## 🎯 快速参考

### 批量拆分模板（固定金额）

#### 模板 1：标准会员费拆分
```
规则1: RM 350 → 会员费
规则2: RM 350 → 会员费
规则3: RM 350 → 会员费
(适用于每笔 RM 1050 的3人会员费转账)
```

#### 模板 2：活动收入拆分（赞助+报名）
```
规则1: RM 500 → 活动财务 (赞助)
规则2: RM 200 → 活动财务 (报名)
(适用于每笔 RM 700 的活动收入)
```

#### 模板 3：混合收入拆分
```
规则1: RM 300 → 会员费
规则2: RM 400 → 活动财务
规则3: RM 100 → 日常账户
(适用于每笔 RM 800 的混合收入)
```

---

## 🔧 技术实现

### 固定金额拆分 🆕
```typescript
// 示例：拆分规则 RM 300 会员费 + RM 200 活动财务
交易金额: RM 1000
拆分结果:
  - 会员费: RM 300.00 (固定)
  - 活动财务: RM 200.00 (固定)
  - 未分配: RM 500.00 (剩余)

// 如果交易金额不足
交易金额: RM 450
拆分结果: ❌ 失败（总金额 RM 500 超过交易金额）
```

### 批量处理流程
```typescript
for (const transactionId of selectedIds) {
  try {
    // 获取交易
    // 验证（未拆分、非虚拟）
    // 计算拆分金额（按百分比）
    // 调用 splitTransaction()
    successCount++;
  } catch (error) {
    failedCount++;
  }
}
```

---

## 🚀 未来增强

- [ ] 保存常用拆分规则模板
- [ ] 批量拆分预览（显示预计结果）
- [ ] 批量拆分进度条
- [ ] 导出拆分规则为模板
- [ ] 批量撤销拆分

---

## 📞 相关功能

- 🔀 [交易拆分功能](./TRANSACTION_SPLIT_FEATURE.md)
- 📋 [批量操作指南](./BULK_OPERATIONS_GUIDE.md)
- 🔍 [搜索功能指南](./SEARCH_FEATURE_GUIDE.md)

---

**最后更新**: 2025-01-16  
**版本**: 1.0  
**适用范围**: 交易管理页面

