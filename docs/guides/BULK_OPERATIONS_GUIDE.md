# 📋 交易管理批量操作指南

## 功能概述

交易管理页面现已支持**批量操作**功能，允许同时选择多条交易记录并执行批量操作，提高工作效率。

---

## 🎯 支持的批量操作

### 1. **批量批准** ✅
批准多条待审核的交易。

**使用场景**：
- 月末批量批准已核实的待审核交易
- 活动结束后批量批准活动收入
- 批量处理会员费缴纳记录

**操作步骤**：
1. 勾选需要批准的交易（状态为"待审核"）
2. 点击批量操作栏的"批量批准"按钮
3. 确认操作
4. 系统逐个批准所有选中的交易

---

### 2. **批量删除** ⚠️
删除多条交易记录。

**使用场景**：
- 删除测试数据
- 清理错误录入的交易
- 批量撤销已取消的交易

**操作步骤**：
1. 勾选需要删除的交易
2. 点击批量操作栏的"批量删除"按钮（红色）
3. 确认删除操作
4. 系统逐个删除并自动回退银行账户余额

**⚠️ 注意**：
- 此操作无法撤销
- 删除交易会自动调整银行账户余额
- 已拆分的父交易删除时，子交易也会被删除

---

### 3. **批量导出** 📤
导出选中的交易记录（开发中）。

**计划功能**：
- 导出为 Excel 格式
- 导出为 PDF 报表
- 自定义导出字段

---

## 📋 行选择规则

### 可选择的交易
✅ **可以选择**：
- 普通交易记录
- 已拆分的父交易

❌ **不能选择**：
- 子交易（虚拟交易）- 复选框被禁用
- 原因：子交易仅作参考，不应单独操作

---

## 🎨 使用界面

### 多选界面
```
┌──────────────────────────────────────────────────────────┐
│ □ 日期        描述           金额        累计余额   操作  │
├──────────────────────────────────────────────────────────┤
│ ☑ 01-Jan    银行转账        +1000      50000    [查看]  │
│   ☐ └─ 会员费-张三 [子项]    300        -       [查看]  │  ← 不可选
│   ☐ └─ 会员费-李四 [子项]    500        -       [查看]  │  ← 不可选
│ ☑ 02-Jan    活动收入        +500       50500    [查看]  │
│ □ 03-Jan    办公用品        -200       50300    [查看]  │
└──────────────────────────────────────────────────────────┘
```

### 批量操作栏（底部浮动）
```
┌──────────────────────────────────────────────────────────┐
│ 已选择 2 项   [批量批准] [导出选中] [批量删除]  [全选] [取消选择] │
└──────────────────────────────────────────────────────────┘
```

---

## 💡 使用技巧

### 1. 快速全选
点击批量操作栏的"全选"按钮，自动选择当前页所有可选交易（排除子交易）。

---

### 2. 翻页后选择
- 当前页选择的记录会保留
- 翻页时，上一页的选择会自动清空（避免跨页误操作）

---

### 3. 筛选后批量操作
```
步骤：
1. 使用筛选器（如状态=待审核）
2. 全选当前页
3. 执行批量操作（如批量批准）
4. 翻页继续处理下一批
```

---

### 4. 智能选择
```
场景：批量批准待审核的会员费
步骤：
1. 状态筛选 → 待审核
2. 类别筛选 → 会员费
3. 点击"全选"
4. 点击"批量批准"
```

---

## 🔧 技术实现

### 行选择配置
```typescript
rowSelection={{
  selectedRowKeys,
  onChange: setSelectedRowKeys,
  getCheckboxProps: (record: Transaction) => ({
    disabled: record.isVirtual === true, // 子交易不可选
  }),
}}
```

### 批量操作逻辑
```typescript
// 批量删除示例
const handleBatchDelete = async (ids: string[]) => {
  for (const id of ids) {
    await deleteTransaction(id, user.id); // 逐个删除，自动回退余额
  }
};
```

---

## ⚠️ 安全机制

### 1. 确认提示
所有批量操作都需要二次确认：
```
┌────────────────────────────────┐
│      确认批量删除              │
├────────────────────────────────┤
│ 确定要删除选中的 5 条交易吗？  │
│ 此操作无法撤销。              │
│                                │
│        [取消]    [删除]        │
└────────────────────────────────┘
```

---

### 2. 子交易保护
- 子交易（虚拟交易）的复选框被禁用
- 防止误选虚拟交易
- 如需删除子交易，需通过父交易的"撤销拆分"功能

---

### 3. 余额自动调整
- 批量删除时，系统会逐个删除交易
- 每次删除都会自动调整银行账户余额
- 确保数据一致性

---

### 4. 翻页清空选择
- 切换页面时自动清空已选择的记录
- 防止误操作跨页的交易
- 提高操作安全性

---

## 📊 批量操作统计

### 操作前提示
```
已选择 10 项
```

### 操作后反馈
```
✅ 已批准 10 条交易
✅ 已删除 5 条交易
✅ 已导出 15 条交易
```

---

## 🎯 典型使用场景

### 场景 1：月末批量批准
```
目标：批准所有待审核的会员费
步骤：
1. 状态筛选 → 待审核
2. 类别筛选 → 会员费
3. 全选
4. 批量批准
5. 翻页继续处理下一批
```

---

### 场景 2：清理测试数据
```
目标：删除所有测试交易
步骤：
1. 搜索框输入 "测试"
2. 全选
3. 批量删除
```

---

### 场景 3：导出月度报表
```
目标：导出某个账户的所有交易
步骤：
1. 切换到特定银行账户标签
2. 筛选日期范围（使用高级筛选）
3. 全选
4. 批量导出
```

---

### 场景 4：批量处理活动收入
```
目标：批准某个活动的所有收入
步骤：
1. 搜索框输入活动名称
2. 类别筛选 → 活动收入
3. 状态筛选 → 待审核
4. 全选
5. 批量批准
```

---

## 🚀 未来增强（计划中）

- [ ] 批量编辑（修改类别、状态等）
- [ ] 批量分配到项目账户
- [ ] 批量打印收据
- [ ] 跨页批量选择
- [ ] 保存批量操作模板
- [ ] 批量操作日志

---

## 📋 操作对比

| 功能 | 单个操作 | 批量操作 | 效率提升 |
|------|---------|----------|---------|
| 批准 | 逐个点击 | 一次批准多条 | ⬆️ 10x |
| 删除 | 逐个确认 | 一次删除多条 | ⬆️ 10x |
| 导出 | 单条导出 | 批量导出 | ⬆️ 5x |

---

## ⚡ 性能优化

### 批量操作优化
```typescript
// 当前实现：串行处理
for (const id of ids) {
  await deleteTransaction(id, user.id);
}

// 未来优化：批处理（Firestore Batch）
const batch = writeBatch(db);
ids.forEach(id => {
  batch.delete(doc(db, 'transactions', id));
});
await batch.commit();
```

---

## 📞 注意事项

1. **操作范围**
   - 批量操作仅在当前页面进行
   - 翻页后之前的选择会被清空

2. **虚拟交易**
   - 子交易（虚拟交易）不可选择
   - 如需删除，通过父交易"撤销拆分"

3. **余额影响**
   - 批量删除会逐个调整银行余额
   - 请谨慎操作，确认数据正确性

4. **性能考虑**
   - 批量操作数量较大时（>100条）可能较慢
   - 建议分批处理

---

**最后更新**: 2025-01-16  
**版本**: 1.0  
**适用范围**: 交易管理页面

