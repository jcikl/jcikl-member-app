# âœ… å‰ç«¯æ•°æ®ä¿®å¤é¡µé¢å®ŒæˆæŠ¥å‘Š

**åˆ›å»ºæ—¶é—´**: 2025-01-13  
**åŠŸèƒ½**: å‰ç«¯é¡µé¢ä¿®å¤äº¤æ˜“è®°å½•çš„ relatedEventId å­—æ®µé—®é¢˜  
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯ä»¥è®¿é—®

---

## ğŸ“‹ åˆ›å»ºçš„æ–‡ä»¶

### 1. æ•°æ®ä¿®å¤é¡µé¢

**æ–‡ä»¶**: `src/pages/DataFixPage.tsx`

**åŠŸèƒ½**:
- âœ… åˆ†æäº¤æ˜“è®°å½•çš„ relatedEventId é—®é¢˜
- âœ… ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜äº¤æ˜“
- âœ… å®æ—¶æ˜¾ç¤ºä¿®å¤è¿›åº¦
- âœ… æƒé™ä¿æŠ¤ï¼ˆä»…ç®¡ç†å‘˜ï¼‰

---

### 2. è·¯ç”±é…ç½®

**æ–‡ä»¶**: `src/routes/index.tsx`

**ä¿®æ”¹**:
```typescript
import DataFixPage from '@/pages/DataFixPage';

// æ·»åŠ è·¯ç”±
{
  path: 'data-fix',
  element: <DataFixPage />,
}
```

**è®¿é—®åœ°å€**: `/data-fix`

---

### 3. ä½¿ç”¨æŒ‡å—

**æ–‡ä»¶**: `DATA_FIX_PAGE_GUIDE.md`

**å†…å®¹**:
- è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- æ•…éšœæ’é™¤æŒ‡å—
- éªŒè¯æ–¹æ³•

---

## ğŸ¯ é¡µé¢åŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½

1. **æ•°æ®åˆ†æ**
   - æ‰«ææ‰€æœ‰äº¤æ˜“è®°å½•
   - åˆ†ç±»ç»Ÿè®¡ï¼šæ­£ç¡®ã€é”™è¯¯ã€æ— æ•ˆã€ç©ºå€¼
   - æ˜¾ç¤ºè¯¦ç»†çš„ç™¾åˆ†æ¯”ç»Ÿè®¡

2. **æ•°æ®ä¿®å¤**
   - è‡ªåŠ¨ä¿®å¤ä½¿ç”¨é”™è¯¯IDçš„äº¤æ˜“
   - æ¸…é™¤æ— æ•ˆçš„ relatedEventId å€¼
   - æ‰¹é‡æ›´æ–°ï¼ˆæ¯æ¬¡500æ¡ï¼‰
   - å®æ—¶æ˜¾ç¤ºä¿®å¤è¿›åº¦

3. **æƒé™ä¿æŠ¤**
   - åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
   - ç™»å½•éªŒè¯
   - è§’è‰²æ£€æŸ¥

---

## ğŸ”’ æƒé™è¦æ±‚

### è®¿é—®æƒé™

- âœ… éœ€è¦ç™»å½•
- âœ… å¿…é¡»æ˜¯ç®¡ç†å‘˜è§’è‰² (super_admin æˆ– admin)
- âŒ æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®

---

## ğŸ“Š é¡µé¢åŠŸèƒ½è¯¦è§£

### 1. åˆ†ææ•°æ®æŒ‰é’®

**åŠŸèƒ½**: 
- åŠ è½½æ‰€æœ‰æ´»åŠ¨å’Œ financialAccount
- æ‰«ææ‰€æœ‰äº¤æ˜“è®°å½•
- åˆ†ç±»ç»Ÿè®¡é—®é¢˜äº¤æ˜“
- æ˜¾ç¤ºåˆ†æç»“æœè¡¨æ ¼

**è¾“å‡º**:
```
æ€»äº¤æ˜“æ•°: 1,578
éœ€è¦ä¿®å¤: 234

æ­£ç¡®: 1,234 (78.5%)
é”™è¯¯ID: 234 (14.9%)
æ— æ•ˆå€¼: 12 (0.8%)
ç©ºå€¼: 89 (5.7%)
```

---

### 2. æ‰§è¡Œä¿®å¤æŒ‰é’®

**åŠŸèƒ½**:
- ä¿®å¤æ‰€æœ‰é—®é¢˜äº¤æ˜“
- å®æ—¶æ˜¾ç¤ºè¿›åº¦
- æ‰¹é‡æ›´æ–°åˆ° Firestore
- å®Œæˆåè‡ªåŠ¨é‡æ–°åˆ†æ

**è¿›åº¦æ˜¾ç¤º**:
```
ä¿®å¤è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%
æ€»æ•°: 234
å·²ä¿®å¤: 187
å¤±è´¥: 0
```

---

## ğŸ” ä¿®å¤é€»è¾‘

### æ•°æ®æµå‘

```
åŠ è½½æ‰€æœ‰æ´»åŠ¨å’Œ financialAccount
    â†“
åˆ›å»ºæ˜ å°„è¡¨:
  - financialAccount -> eventId
  - eventId -> financialAccount
    â†“
æ‰«ææ‰€æœ‰äº¤æ˜“
    â†“
æ£€æŸ¥ relatedEventId
    â†“
æ˜¯å¦æ˜¯ financialAccount?
  â†’ æ˜¯ â†’ âœ… è·³è¿‡ï¼ˆæ­£ç¡®ï¼‰
  â†’ å¦ â†’ ç»§ç»­æ£€æŸ¥
    â†“
æ˜¯å¦æ˜¯ eventId?
  â†’ æ˜¯ â†’ ğŸ”§ æ›´æ–°ä¸ºå¯¹åº” financialAccount
  â†’ å¦ â†’ ğŸ—‘ï¸ æ¸…é™¤ï¼ˆæ— æ•ˆå€¼ï¼‰
    â†“
æ‰¹é‡æ›´æ–°åˆ° Firestore
  - æ¯æ¬¡æ›´æ–°500æ¡
  - å®æ—¶æ˜¾ç¤ºè¿›åº¦
    â†“
é‡æ–°åˆ†ææ•°æ®
    â†“
æ˜¾ç¤ºæœ€ç»ˆç»“æœ
```

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ ¸å¿ƒä»£ç 

```typescript
// 1. åˆ†æäº¤æ˜“è®°å½•
const handleAnalyze = async () => {
  // åŠ è½½æ‰€æœ‰æ´»åŠ¨
  const eventsSnapshot = await getDocs(query(collection(db, GLOBAL_COLLECTIONS.EVENTS)));
  
  // åˆ›å»ºæ˜ å°„è¡¨
  const eventIdToFinancialAccountMap = new Map<string, string>();
  const financialAccountSet = new Set<string>();
  
  // æ‰«æäº¤æ˜“å¹¶åˆ†ç±»ç»Ÿè®¡
  // ...
  
  setAnalysis(stats);
};

// 2. ä¿®å¤äº¤æ˜“è®°å½•
const handleFix = async () => {
  // è·å–éœ€è¦ä¿®å¤çš„äº¤æ˜“
  const transactionsToFix = [];
  
  // æ‰¹é‡æ›´æ–°ï¼ˆæ¯æ¬¡500æ¡ï¼‰
  const batch = writeBatch(db);
  // ...
  await batch.commit();
  
  // é‡æ–°åˆ†æ
  await handleAnalyze();
};
```

---

## âš™ï¸ ä½¿ç”¨æ­¥éª¤

### Step 1: è®¿é—®é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
http://localhost:5173/data-fix
```

---

### Step 2: åˆ†ææ•°æ®

ç‚¹å‡» **"åˆ†ææ•°æ®"** æŒ‰é’®ï¼š
- ç³»ç»Ÿè‡ªåŠ¨æ‰«ææ‰€æœ‰äº¤æ˜“
- æ˜¾ç¤ºè¯¦ç»†çš„åˆ†æç»“æœ
- ç»Ÿè®¡å„ç±»åˆ«æ•°é‡å’Œå æ¯”

---

### Step 3: æ‰§è¡Œä¿®å¤

ç¡®è®¤åˆ†æç»“æœåï¼Œç‚¹å‡» **"æ‰§è¡Œä¿®å¤"** æŒ‰é’®ï¼š
- ç³»ç»Ÿè‡ªåŠ¨ä¿®å¤æ‰€æœ‰é—®é¢˜
- å®æ—¶æ˜¾ç¤ºä¿®å¤è¿›åº¦
- å®Œæˆåè‡ªåŠ¨é‡æ–°åˆ†æ

---

### Step 4: éªŒè¯ç»“æœ

æ£€æŸ¥ä¿®å¤åçš„ç»“æœï¼š
- âœ… éœ€è¦ä¿®å¤æ•°é‡åº”è¯¥ä¸º 0
- âœ… æ­£ç¡®çš„æ•°é‡åº”è¯¥å¢åŠ 
- âœ… åœ¨æ´»åŠ¨è´¦æˆ·ç®¡ç†é¡µé¢éªŒè¯

---

## ğŸ¯ ä¸åç«¯è„šæœ¬çš„åŒºåˆ«

### åç«¯è„šæœ¬ (Node.js)

**ä¼˜ç‚¹**:
- âœ… ä½¿ç”¨ Firebase Admin SDKï¼ˆæ— æƒé™é™åˆ¶ï¼‰
- âœ… å¯ä»¥å¤„ç†å¤§é‡æ•°æ®
- âœ… ä¸å—æµè§ˆå™¨é…é¢é™åˆ¶

**ç¼ºç‚¹**:
- âŒ éœ€è¦ Node.js ç¯å¢ƒ
- âŒ éœ€è¦ serviceAccountKey.json
- âŒ éœ€è¦æ‰‹åŠ¨è¿è¡Œå‘½ä»¤

---

### å‰ç«¯é¡µé¢ (React)

**ä¼˜ç‚¹**:
- âœ… å›¾å½¢åŒ–ç•Œé¢ï¼Œæ“ä½œç®€å•
- âœ… å®æ—¶æ˜¾ç¤ºè¿›åº¦
- âœ… ä¸éœ€è¦ Node.js ç¯å¢ƒ
- âœ… å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®

**ç¼ºç‚¹**:
- âš ï¸ å— Firestore å®‰å…¨è§„åˆ™é™åˆ¶
- âš ï¸ å—æµè§ˆå™¨é…é¢é™åˆ¶
- âš ï¸ ä¸é€‚åˆå¤„ç†è¶…å¤§æ•°æ®ï¼ˆ>10000æ¡ï¼‰

---

## ğŸ“Š æ€§èƒ½è¯´æ˜

### æ‰¹é‡å¤„ç†ç­–ç•¥

```typescript
const batchSize = 500; // æ¯æ¬¡æ›´æ–°500æ¡

for (let i = 0; i < transactionsToFix.length; i += batchSize) {
  const batch = writeBatch(db);
  // ...
  await batch.commit();
  // å®æ—¶æ›´æ–°è¿›åº¦
}
```

### å®æ—¶è¿›åº¦æ›´æ–°

```typescript
setProgress({
  total: transactionsToFix.length,
  fixed,
  failed,
  percentage: Math.round((fixed / transactionsToFix.length) * 100)
});
```

---

## âœ… æ€»ç»“

### åˆ›å»ºçš„å†…å®¹

1. âœ… **src/pages/DataFixPage.tsx** - æ•°æ®ä¿®å¤é¡µé¢
2. âœ… **src/routes/index.tsx** - è·¯ç”±é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰
3. âœ… **DATA_FIX_PAGE_GUIDE.md** - ä½¿ç”¨æŒ‡å—

### åŠŸèƒ½ç‰¹ç‚¹

- âœ… å›¾å½¢åŒ–ç•Œé¢ï¼Œæ“ä½œç®€å•
- âœ… å®æ—¶æ˜¾ç¤ºåˆ†æå’Œä¿®å¤è¿›åº¦
- âœ… æƒé™ä¿æŠ¤ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
- âœ… æ‰¹é‡å¤„ç†ï¼Œè‡ªåŠ¨ä¼˜åŒ–æ€§èƒ½
- âœ… è‡ªåŠ¨éªŒè¯ä¿®å¤ç»“æœ

### è®¿é—®æ–¹å¼

**å¼€å‘ç¯å¢ƒ**:
```
http://localhost:5173/data-fix
```

**ç”Ÿäº§ç¯å¢ƒ**:
```
https://your-domain.com/data-fix
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜è§’è‰² (super_admin æˆ– admin)

---

**åˆ›å»ºæ—¶é—´**: 2025-01-13  
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯ä»¥è®¿é—®ä½¿ç”¨
