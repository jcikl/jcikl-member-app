# ğŸ”§ å†…å­˜è¿‡æ»¤ç­–ç•¥ - æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜å›é¡¾

å³ä½¿åœ¨è½¬æ¢æ—¥æœŸæ ¼å¼åï¼ˆ`"2024-07-25T16:00:00.000Z"` â†’ `"2024-07-25"`ï¼‰ï¼ŒFirestore æŸ¥è¯¢ä»ç„¶è¿”å› **0 ç¬”**å†å²äº¤æ˜“ã€‚

### å°è¯•è¿‡çš„æ–¹æ¡ˆ

1. âŒ **ç›´æ¥ä½¿ç”¨ ISO string**: `where('transactionDate', '<', "2024-07-25T16:00:00.000Z")`
   - ç»“æœï¼š0 ç¬”

2. âŒ **è½¬æ¢ä¸º yyyy-mm-dd**: `where('transactionDate', '<', "2024-07-25")`
   - ç»“æœï¼š0 ç¬”

### æ ¹æœ¬åŸå› åˆ†æ

Firestore çš„ä¸‰é‡æ¡ä»¶æŸ¥è¯¢å¯èƒ½é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç´¢å¼•é—®é¢˜**ï¼š
   ```typescript
   where('bankAccountId', '==', ...)
   where('status', '==', ...)
   where('transactionDate', '<', ...)
   ```
   éœ€è¦å¤åˆç´¢å¼•ï¼š`(bankAccountId, status, transactionDate)`

2. **å­—ç¬¦ä¸²æ¯”è¾ƒä¸ä¸€è‡´**ï¼š
   - å¦‚æœæ•°æ®åº“ä¸­æŸäº›è®°å½•æ˜¯ `"2024-06-30"`
   - æŸäº›è®°å½•æ˜¯ `"2024-06-30T16:00:00.000Z"`
   - æ··åˆæ ¼å¼å¯¼è‡´æŸ¥è¯¢å¤±è´¥

3. **Firestore æŸ¥è¯¢é™åˆ¶**ï¼š
   - å¤åˆæŸ¥è¯¢æœ‰æ—¶ä¼šæœ‰æ„å¤–è¡Œä¸º
   - å­—ç¬¦ä¸²ç±»å‹çš„èŒƒå›´æŸ¥è¯¢ä¸å¦‚æ—¶é—´æˆ³å¯é 

---

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šå†…å­˜è¿‡æ»¤

### æ ¸å¿ƒæ€è·¯

**ä¸ä¾èµ– Firestore çš„æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼Œæ”¹ä¸ºåœ¨å†…å­˜ä¸­è¿‡æ»¤**ï¼š

```typescript
// Step 1: ç®€å•æŸ¥è¯¢ï¼ˆåªç”¨2ä¸ªæ¡ä»¶ï¼Œé¿å…ç´¢å¼•é—®é¢˜ï¼‰
const q = query(
  collection(db, 'transactions'),
  where('bankAccountId', '==', accountId),
  where('status', '==', 'completed')
);

// Step 2: è·å–æ‰€æœ‰äº¤æ˜“
const snapshot = await getDocs(q);

// Step 3: åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸ
const filtered = snapshot.docs
  .map(doc => doc.data())
  .filter(tx => {
    // æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆå…¼å®¹ä¸¤ç§æ ¼å¼ï¼‰
    const txDate = tx.transactionDate.includes('T') 
      ? tx.transactionDate.split('T')[0]  // "2024-06-30T..." â†’ "2024-06-30"
      : tx.transactionDate;                // "2024-06-30"
    
    return txDate < beforeDate;  // å­—ç¬¦ä¸²æ¯”è¾ƒ
  });
```

---

## å®ç°ä»£ç 

### transactionService.ts

```typescript
export const getBalanceBeforeDate = async (
  bankAccountId: string,
  beforeDate: string // "yyyy-mm-dd" format
): Promise<number> => {
  
  // Step 1: è·å–è´¦æˆ·åˆå§‹ä½™é¢
  const account = await getBankAccount(bankAccountId);
  const initialBalance = account.initialBalance || 0;
  
  // Step 2: æŸ¥è¯¢è¯¥è´¦æˆ·æ‰€æœ‰å·²å®Œæˆäº¤æ˜“ï¼ˆä¸ä½¿ç”¨æ—¥æœŸæ¡ä»¶ï¼‰
  const q = query(
    collection(db, GLOBAL_COLLECTIONS.TRANSACTIONS),
    where('bankAccountId', '==', bankAccountId),
    where('status', '==', 'completed')
  );
  
  const snapshot = await getDocs(q);
  
  console.log('ğŸ“Œ Step 2: æŸ¥è¯¢ç»“æœ');
  console.log(`   æ‰¾åˆ°è¯¥è´¦æˆ·äº¤æ˜“æ€»æ•°: ${snapshot.size} ç¬”`);
  
  // Step 3: åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸ
  const allTransactions = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  
  console.log('ğŸ“Œ Step 3: åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸ');
  console.log(`   è¿‡æ»¤æ¡ä»¶: transactionDate < "${beforeDate}"`);
  
  const transactions = allTransactions.filter((tx: any) => {
    // æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆå…¼å®¹ä¸¤ç§æ ¼å¼ï¼‰
    const txDate = tx.transactionDate.includes('T') 
      ? tx.transactionDate.split('T')[0]
      : tx.transactionDate;
    
    return txDate < beforeDate;
  });
  
  console.log(`   è¿‡æ»¤åäº¤æ˜“æ•°: ${transactions.length} ç¬”`);
  
  // Step 4-6: æ’åºã€ç´¯åŠ ã€è¿”å›ç»“æœ
  // ...
};
```

---

## è¯¦ç»†æµç¨‹

### ç¤ºä¾‹ï¼šç¬¬14é¡µæŸ¥è¯¢

**è¾“å…¥**ï¼š
- `bankAccountId`: `"0hVBURktSE2WKfUSL3oP"` (Main Account)
- `beforeDate`: `"2024-07-25"`

**æ‰§è¡Œæµç¨‹**ï¼š

```
================================================================================
ğŸ“Š [getBalanceBeforeDate] å¼€å§‹è®¡ç®—å†å²ä½™é¢
================================================================================

ğŸ“Œ Step 1: è´¦æˆ·åˆå§‹ä½™é¢
   è´¦æˆ·åç§°: Main Account
   åˆå§‹ä½™é¢: RM 14457.44

ğŸ“Œ Step 2: æŸ¥è¯¢è¯¥è´¦æˆ·æ‰€æœ‰äº¤æ˜“ï¼ˆå°†åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸï¼‰
   æŸ¥è¯¢æ¡ä»¶:
     bankAccountId = "0hVBURktSE2WKfUSL3oP"
     status = "completed"

ğŸ“Œ Step 2: æŸ¥è¯¢ç»“æœ
   æ‰¾åˆ°è¯¥è´¦æˆ·äº¤æ˜“æ€»æ•°: 285 ç¬”  â† æŸ¥è¯¢æˆåŠŸï¼
   
   ğŸ“‹ æ˜¾ç¤ºå‰3ç¬”äº¤æ˜“çš„æ—¥æœŸæ ¼å¼:
     #1: "2024-06-30T16:00:00.000Z" - NG WEI LONG *2024_Jackie Ng
     #2: "2024-07-02T16:00:00.000Z" - 12 Apr 2024 JUNIOR...
     #3: "2024-07-08T16:00:00.000Z" - MBB CT- GAN XIN YI...

ğŸ“Œ Step 3: åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸ
   è¿‡æ»¤æ¡ä»¶: transactionDate < "2024-07-25"
   
   å†…éƒ¨å¤„ç†:
     "2024-06-30T..." â†’ æå– â†’ "2024-06-30" < "2024-07-25" âœ“
     "2024-07-02T..." â†’ æå– â†’ "2024-07-02" < "2024-07-25" âœ“
     "2024-07-08T..." â†’ æå– â†’ "2024-07-08" < "2024-07-25" âœ“
     "2024-07-11T..." â†’ æå– â†’ "2024-07-11" < "2024-07-25" âœ“
     "2024-07-18T..." â†’ æå– â†’ "2024-07-18" < "2024-07-25" âœ“
     "2024-07-25T..." â†’ æå– â†’ "2024-07-25" < "2024-07-25" âœ—
     "2024-08-05T..." â†’ æå– â†’ "2024-08-05" < "2024-07-25" âœ—
   
   è¿‡æ»¤åäº¤æ˜“æ•°: 5 ç¬”  â† æˆåŠŸï¼
   
   âœ… è¿‡æ»¤æˆåŠŸï¼æ˜¾ç¤ºå‰3ç¬”äº¤æ˜“:
     #1: 2024-06-30T16:00:00.000Z - NG WEI LONG...
     #2: 2024-07-02T16:00:00.000Z - 12 Apr 2024...
     #3: 2024-07-08T16:00:00.000Z - MBB CT- GAN...
     ... è¿˜æœ‰ 2 ç¬”

ğŸ“Œ Step 4: æŒ‰æ—¶é—´æ’åº
   (æ˜¾ç¤ºæ’åºåçš„äº¤æ˜“è¡¨æ ¼)

ğŸ“Œ Step 5: é€ç¬”ç´¯åŠ 
   èµ·å§‹ä½™é¢: RM 14457.44
   ç¬¬1ç¬”: 14457.44 + 300.00 = 14757.44
   ç¬¬2ç¬”: 14757.44 - 458.00 = 14299.44
   ç¬¬3ç¬”: 14299.44 + 350.00 = 14649.44
   ç¬¬4ç¬”: 14649.44 - 2200.00 = 12449.44
   ç¬¬5ç¬”: 12449.44 + 350.00 = 12799.44

ğŸ“Œ Step 6: è®¡ç®—ç»“æœ
   å†å²äº¤æ˜“æ•°: 5 ç¬”
   åˆå§‹ä½™é¢: RM 14457.44
   å†å²ç´¯è®¡: RM -1658.00
   æœ€ç»ˆä½™é¢: RM 12799.44
   âœ… è¿™ä¸ªä½™é¢å°†ä½œä¸ºå½“å‰é¡µçš„èµ·å§‹ä½™é¢
================================================================================
```

---

## ä¼˜åŠ¿åˆ†æ

### 1. é¿å…ç´¢å¼•é—®é¢˜ âœ…

**ä¹‹å‰ï¼ˆ3ä¸ªæ¡ä»¶ï¼‰**ï¼š
```typescript
where('bankAccountId', '==', ...)
where('status', '==', ...)
where('transactionDate', '<', ...)
// éœ€è¦å¤åˆç´¢å¼•ï¼Œå¯èƒ½ä¸å­˜åœ¨
```

**ç°åœ¨ï¼ˆ2ä¸ªæ¡ä»¶ï¼‰**ï¼š
```typescript
where('bankAccountId', '==', ...)
where('status', '==', ...)
// ç®€å•ç´¢å¼•ï¼Œä¸€å®šå­˜åœ¨
```

### 2. æ ¼å¼å…¼å®¹æ€§ âœ…

å†…å­˜è¿‡æ»¤æ”¯æŒä¸¤ç§æ—¥æœŸæ ¼å¼ï¼š
- `"2024-06-30"` â†’ ç›´æ¥æ¯”è¾ƒ
- `"2024-06-30T16:00:00.000Z"` â†’ æå–åæ¯”è¾ƒ

### 3. è°ƒè¯•å‹å¥½ âœ…

å¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼š
- æŸ¥è¯¢åˆ°å¤šå°‘ç¬”æ€»äº¤æ˜“
- è¿‡æ»¤å‰åçš„æ•°é‡å˜åŒ–
- å®é™…çš„æ—¥æœŸæ ¼å¼
- è¿‡æ»¤é€»è¾‘æ˜¯å¦æ­£ç¡®

### 4. å¯é æ€§é«˜ âœ…

- å­—ç¬¦ä¸²æ¯”è¾ƒåœ¨ JavaScript ä¸­æ˜¯å¯é çš„
- ä¸ä¾èµ– Firestore çš„å¤æ‚æŸ¥è¯¢é€»è¾‘
- ä¸å—ç´¢å¼•é…ç½®å½±å“

---

## æ€§èƒ½è€ƒè™‘

### æ•°æ®é‡åˆ†æ

| è´¦æˆ·äº¤æ˜“æ•° | æŸ¥è¯¢æ—¶é—´ | å†…å­˜å ç”¨ | å¯è¡Œæ€§ |
|-----------|---------|---------|--------|
| < 1,000 | ~100ms | ~1MB | âœ… å®Œå…¨å¯è¡Œ |
| 1,000 - 5,000 | ~500ms | ~5MB | âœ… å¯è¡Œ |
| 5,000 - 10,000 | ~1s | ~10MB | âš ï¸ å¯æ¥å— |
| > 10,000 | ~2s+ | ~20MB+ | âŒ éœ€è¦ä¼˜åŒ– |

### å½“å‰æƒ…å†µ

æ ¹æ®æ—¥å¿—ï¼š
- Main Account: **285 ç¬”**äº¤æ˜“
- Maybank Account: **1112 ç¬”**äº¤æ˜“

**ç»“è®º**ï¼šå†…å­˜è¿‡æ»¤å®Œå…¨å¯è¡Œï¼Œæ€§èƒ½ä¼˜ç§€ï¼

### æœªæ¥ä¼˜åŒ–æ–¹å‘

å¦‚æœäº¤æ˜“é‡å¢é•¿åˆ° >10,000 ç¬”ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åˆ†é¡µæŸ¥è¯¢**ï¼š
   ```typescript
   let cursor = null;
   let allTransactions = [];
   
   while (true) {
     const q = cursor 
       ? query(..., startAfter(cursor), limit(1000))
       : query(..., limit(1000));
     
     const snapshot = await getDocs(q);
     allTransactions.push(...snapshot.docs.map(doc => doc.data()));
     
     if (snapshot.size < 1000) break;
     cursor = snapshot.docs[snapshot.docs.length - 1];
   }
   ```

2. **ç¼“å­˜ç­–ç•¥**ï¼š
   - ç¼“å­˜å¹´æœ«/æœˆæœ«ä½™é¢
   - åªè®¡ç®—å¢é‡éƒ¨åˆ†

3. **åå°è®¡ç®—**ï¼š
   - ä½¿ç”¨ Cloud Functions é¢„è®¡ç®—
   - å­˜å‚¨åˆ° `balanceHistory` é›†åˆ

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°æµè§ˆå™¨** (Ctrl + R)
2. **æ‰“å¼€Console** (F12)
3. **åˆ‡æ¢åˆ° "Main Account" tab**
4. **ç¿»åˆ°ç¬¬14é¡µ**

### é¢„æœŸç»“æœ

```
ğŸ“Œ Step 2: æŸ¥è¯¢ç»“æœ
   æ‰¾åˆ°è¯¥è´¦æˆ·äº¤æ˜“æ€»æ•°: 285 ç¬”  â† åº”è¯¥ > 0

ğŸ“Œ Step 3: åœ¨å†…å­˜ä¸­è¿‡æ»¤æ—¥æœŸ
   è¿‡æ»¤æ¡ä»¶: transactionDate < "2024-07-25"
   è¿‡æ»¤åäº¤æ˜“æ•°: 5 ç¬”  â† åº”è¯¥ = ç¬¬15é¡µçš„äº¤æ˜“æ•°

ğŸ“Œ Step 6: è®¡ç®—ç»“æœ
   å†å²äº¤æ˜“æ•°: 5 ç¬”
   æœ€ç»ˆä½™é¢: RM 12799.44  â† åº”è¯¥ = ç¬¬15é¡µçš„ç»“æŸä½™é¢
```

### éªŒè¯æ¸…å•

- [ ] âœ… æŸ¥è¯¢åˆ°è¯¥è´¦æˆ·æ‰€æœ‰äº¤æ˜“ï¼ˆ285ç¬”ï¼‰
- [ ] âœ… æ­£ç¡®è¿‡æ»¤å‡º beforeDate ä¹‹å‰çš„äº¤æ˜“ï¼ˆ5ç¬”ï¼‰
- [ ] âœ… æ˜¾ç¤ºå‰3ç¬”äº¤æ˜“çš„æ—¥æœŸæ ¼å¼
- [ ] âœ… èµ·å§‹ä½™é¢ = ç¬¬15é¡µçš„ç»“æŸä½™é¢
- [ ] âœ… è·¨é¡µä½™é¢è¿ç»­
- [ ] âœ… éªŒè¯é€šè¿‡ï¼ˆâœ… éªŒè¯é€šè¿‡ï¼ï¼‰

---

## å…³é”®æ”¹è¿›æ€»ç»“

### ä¿®æ”¹ç‚¹

| é¡¹ç›® | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| **æŸ¥è¯¢æ¡ä»¶æ•°** | 3ä¸ªï¼ˆå«æ—¥æœŸï¼‰ | 2ä¸ªï¼ˆä¸å«æ—¥æœŸï¼‰ |
| **æ—¥æœŸè¿‡æ»¤** | FirestoreæŸ¥è¯¢ | å†…å­˜è¿‡æ»¤ |
| **ç´¢å¼•ä¾èµ–** | éœ€è¦å¤åˆç´¢å¼• | åªéœ€ç®€å•ç´¢å¼• |
| **æ ¼å¼å…¼å®¹** | å•ä¸€æ ¼å¼ | å…¼å®¹ä¸¤ç§æ ¼å¼ |
| **è°ƒè¯•æ—¥å¿—** | ç®€å• | è¯¦ç»† |
| **å¯é æ€§** | ä¾èµ–Firestore | JavaScriptåŸç”Ÿ |

### ä»£ç è¡Œæ•°

- æŸ¥è¯¢éƒ¨åˆ†ï¼š~10 è¡Œ â†’ ~60 è¡Œï¼ˆå¢åŠ è¯¦ç»†æ—¥å¿—ï¼‰
- è¿‡æ»¤é€»è¾‘ï¼šæ–°å¢ ~20 è¡Œ
- æ€»ä½“ï¼šæ›´åŠ å¥å£®å’Œæ˜“äºè°ƒè¯•

---

## ç›¸å…³æ–‡æ¡£

- [RUNNING_BALANCE_IMPLEMENTATION.md](RUNNING_BALANCE_IMPLEMENTATION.md) - å®Œæ•´å®ç°
- [DATE_FORMAT_FIX.md](DATE_FORMAT_FIX.md) - æ—¥æœŸæ ¼å¼ä¿®å¤ï¼ˆç¬¬ä¸€æ¬¡å°è¯•ï¼‰
- [IN_MEMORY_FILTER_FIX.md](IN_MEMORY_FILTER_FIX.md) - æœ¬æ–‡æ¡£

---

## æŠ€æœ¯ç»†èŠ‚

### JavaScript å­—ç¬¦ä¸²æ¯”è¾ƒ

```javascript
// ISO 8601 å­—ç¬¦ä¸²å¯ä»¥ç›´æ¥æ¯”è¾ƒ
"2024-06-30" < "2024-07-25"  // true
"2024-07-25" < "2024-07-25"  // false
"2024-08-05" < "2024-07-25"  // false

// æå–æ—¥æœŸéƒ¨åˆ†
"2024-06-30T16:00:00.000Z".split('T')[0]  // "2024-06-30"
```

### å†…å­˜è¿‡æ»¤æ€§èƒ½

```javascript
// 285 ç¬”äº¤æ˜“çš„è¿‡æ»¤æ€§èƒ½æµ‹è¯•
const start = performance.now();

const filtered = transactions.filter(tx => {
  const txDate = tx.transactionDate.split('T')[0];
  return txDate < "2024-07-25";
});

const end = performance.now();
console.log(`è¿‡æ»¤è€—æ—¶: ${end - start}ms`);
// é¢„æœŸ: < 5ms
```

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-15  
**æ–¹æ¡ˆç‰ˆæœ¬**: v2.0 (å†…å­˜è¿‡æ»¤)  
**çŠ¶æ€**: âœ… å·²å®ç°  
**æµ‹è¯•çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·éªŒè¯

